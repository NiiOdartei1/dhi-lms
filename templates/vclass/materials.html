{% extends 'vclass/base_vclass.html' %}
{% block title %}Materials — {{ course_name }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  .file-card {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    cursor: pointer;
  }
  .file-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  .thumbnail {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
  }
  .filter-row { gap: 0.5rem; }
</style>

<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-0">{{ course_name }}</h4>
      <small class="text-muted">Materials for this course</small>
    </div>
    <div>
      <a href="{{ url_for('vclass.materials_overview') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Back to courses
      </a>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row filter-row">
        <div class="col-md-6 mb-2">
          <input id="materialSearch" class="form-control" placeholder="Search files">
        </div>
        <div class="col-md-4 mb-2">
          <select id="filter-type" class="form-select">
            <option value="">All types</option>
            <option value="pdf">PDF</option>
            <option value="image">Image</option>
            <option value="video">Video</option>
            <option value="doc">Document</option>
          </select>
        </div>
        <div class="col-md-2 mb-2 text-end">
          <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Materials Grid -->
  <div class="row g-3" id="materials-list"></div>
  <div id="no-materials" class="text-center text-muted mt-3 d-none">No materials found.</div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="preview-body" class="d-flex justify-content-center align-items-center" style="min-height:360px"></div>
      </div>
      <div class="modal-footer">
        <a id="preview-download" class="btn btn-outline-primary" target="_blank">Download</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="data-container" data-materials='{{ materials | tojson }}' style="display:none"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const materials = JSON.parse(document.getElementById('data-container').dataset.materials || '[]');
  const list = document.getElementById('materials-list');
  const noMaterials = document.getElementById('no-materials');

  function fileIcon(m) {
    const ext = (m.file_type || '').toLowerCase();
    if (['jpg','jpeg','png','gif','bmp','svg','webp'].includes(ext))
      return `<img src="/vclass/preview/materials/${encodeURIComponent(m.filename)}" class="thumbnail mb-2">`;
    if (ext === 'pdf') return '<i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>';
    if (['doc','docx'].includes(ext)) return '<i class="fas fa-file-word fa-3x text-primary mb-2"></i>';
    if (['ppt','pptx'].includes(ext)) return '<i class="fas fa-file-powerpoint fa-3x text-warning mb-2"></i>';
    if (['mp4','webm','ogg'].includes(ext)) return '<i class="fas fa-video fa-3x text-dark mb-2"></i>';
    return '<i class="fas fa-file fa-3x text-muted mb-2"></i>';
  }

  function rowHtml(m) {
    return `
      <div class="col-md-4 col-sm-6">
        <div class="card file-card h-100 p-2">
          ${fileIcon(m)}
          <div class="card-body p-1">
            <h6 class="card-title text-truncate">${(m.original_name||'').replace(/</g,'&lt;')}</h6>
            <small class="text-muted d-block mb-2">${m.course_name || ''} • ${m.uploaded_at ? new Date(m.uploaded_at).toLocaleDateString() : ''}</small>
            <div class="d-flex justify-content-between">
              <button class="btn btn-outline-secondary btn-sm preview-btn" data-file="${encodeURIComponent(m.filename)}" data-type="${m.file_type}">Preview</button>
              <a class="btn btn-primary btn-sm" href="/vclass/download/materials/${encodeURIComponent(m.filename)}" target="_blank">Download</a>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function render(items) {
    list.innerHTML = '';
    if (!items.length) return noMaterials.classList.remove('d-none');
    noMaterials.classList.add('d-none');
    items.forEach(m => list.insertAdjacentHTML('beforeend', rowHtml(m)));
  }

  render(materials);

  // Preview modal
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('preview-btn')) return;
    const filename = decodeURIComponent(e.target.dataset.file);
    const type = (e.target.dataset.type || '').toLowerCase();
    if (['mp4','webm','ogg'].includes(type)) {
      window.location.href = `/vclass/material/video/${filename}`;
      return;
    }
    const previewBody = document.getElementById('preview-body');
    const previewUrl = `/vclass/preview/materials/${filename}`;
    document.getElementById('previewModalLabel').innerText = filename;
    document.getElementById('preview-download').href = previewUrl;

    if (type === 'pdf') previewBody.innerHTML = `<iframe src="${previewUrl}" width="100%" height="600" style="border:0"></iframe>`;
    else if (['jpg','jpeg','png','gif','bmp','svg','webp'].includes(type))
      previewBody.innerHTML = `<img src="${previewUrl}" style="max-width:100%; max-height:70vh; border-radius:8px">`;
    else previewBody.innerHTML = `<div class="text-center text-muted">Preview not available. <a href="${previewUrl}" target="_blank">Open</a> or download.</div>`;

    new bootstrap.Modal(document.getElementById('previewModal')).show();
  });

  // Filters
  const search = document.getElementById('materialSearch');
  const filterType = document.getElementById('filter-type');
  const resetBtn = document.getElementById('resetBtn');

  function applyFilters() {
    const q = (search.value || '').trim().toLowerCase();
    const t = filterType.value;
    const filtered = materials.filter(m => {
      const ext = (m.file_type || '').toLowerCase();
      const matchesType = !t || (t==='video' && ['mp4','webm','ogg'].includes(ext)) || (t==='pdf' && ext==='pdf') || (t==='image' && ['jpg','jpeg','png','gif','bmp','svg','webp'].includes(ext)) || (t==='doc' && ['doc','docx','ppt','pptx'].includes(ext));
      const matchesQuery = !q || ((m.original_name||'').toLowerCase().includes(q));
      return matchesType && matchesQuery;
    });
    render(filtered);
  }

  search.addEventListener('input', applyFilters);
  filterType.addEventListener('change', applyFilters);
  resetBtn.addEventListener('click', () => { search.value=''; filterType.value=''; render(materials); });
});
</script>
{% endblock %}
