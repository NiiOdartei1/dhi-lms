{% extends 'exam/base_exam.html' %}
{% block title %}Exam Result ‚Äì {{ exam.title }}{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap');

  :root {
    --primary: #4e73df;
    --success: #1cc88a;
    --danger: #e74c3c;
    --warning: #f39c12;
    --info: #3498db;
    --dark: #2c3e50;
    --light: #f8f9fa;
    --border: #e9ecef;
    --text-primary: #2c3e50;
    --text-muted: #7f8c8d;
  }

  * {
    font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }

  .result-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem 1rem;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* ===== PASS STATE ===== */
  .result-card-pass {
    background: white;
    border-radius: 20px;
    padding: 3rem 2rem;
    box-shadow: 0 20px 60px rgba(28, 200, 138, 0.15);
    text-align: center;
    animation: slideUpPass 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes slideUpPass {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .pass-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 2rem;
    background: linear-gradient(135deg, var(--success) 0%, #16a085 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: bounceIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 10px 30px rgba(28, 200, 138, 0.3);
  }

  @keyframes bounceIn {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .pass-icon svg {
    width: 70px;
    height: 70px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .pass-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--success);
    margin-bottom: 0.5rem;
    animation: fadeInScale 0.6s ease 0.2s both;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .pass-subtitle {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 2rem;
    animation: fadeInScale 0.6s ease 0.3s both;
  }

  /* ===== FAIL STATE ===== */
  .result-card-fail {
    background: white;
    border-radius: 20px;
    padding: 3rem 2rem;
    box-shadow: 0 20px 60px rgba(230, 57, 70, 0.15);
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: slideUpFail 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes slideUpFail {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fail-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 2rem;
    background: linear-gradient(135deg, #ff6b6b 0%, var(--danger) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: shakeIcon 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s;
    box-shadow: 0 10px 30px rgba(230, 57, 70, 0.3);
  }

  @keyframes shakeIcon {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.05) rotate(-3deg); }
    50% { transform: scale(1.05) rotate(3deg); }
    75% { transform: scale(1.05) rotate(-2deg); }
  }

  .fail-icon svg {
    width: 70px;
    height: 70px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .fail-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--danger);
    margin-bottom: 0.5rem;
    animation: fadeInScale 0.6s ease 0.3s both;
  }

  .fail-subtitle {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    animation: fadeInScale 0.6s ease 0.4s both;
  }

  .fail-hint {
    background: #fff3cd;
    border-left: 4px solid var(--warning);
    padding: 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #856404;
    margin-bottom: 2rem;
    animation: fadeInScale 0.6s ease 0.5s both;
  }

  /* ===== SCORE CARD ===== */
  .score-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    animation: fadeInScale 0.6s ease 0.35s both;
  }

  .score-display {
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 2rem;
  }

  .score-item {
    text-align: center;
  }

  .score-label {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .score-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary);
    font-family: 'Courier New', monospace;
    letter-spacing: 2px;
  }

  .score-divider {
    width: 2px;
    height: 60px;
    background: var(--border);
  }

  .score-percentage {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--success);
  }

  /* ===== EXAM INFO ===== */
  .exam-info {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid var(--primary);
    animation: fadeInScale 0.6s ease 0.4s both;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
  }

  .info-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .info-label {
    color: var(--text-muted);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .info-value {
    color: var(--text-primary);
    font-weight: 600;
  }

  /* ===== BUTTONS ===== */
  .button-group {
    display: flex;
    gap: 1rem;
    animation: fadeInScale 0.6s ease 0.5s both;
  }

  .btn-home {
    flex: 1;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
  }

  .btn-home:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(78, 115, 223, 0.4);
  }

  .btn-home:active {
    transform: translateY(0);
  }

  /* ===== CANVAS FOR PARTICLES ===== */
  #particle-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .result-container {
    position: relative;
    z-index: 2;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .result-card-pass,
    .result-card-fail {
      padding: 2rem 1.5rem;
    }

    .pass-title,
    .fail-title {
      font-size: 1.6rem;
    }

    .pass-subtitle,
    .fail-subtitle {
      font-size: 1rem;
    }

    .score-display {
      gap: 1rem;
    }

    .score-value {
      font-size: 2rem;
    }

    .score-percentage {
      font-size: 1.2rem;
    }

    .pass-icon,
    .fail-icon {
      width: 100px;
      height: 100px;
      margin-bottom: 1.5rem;
    }

    .button-group {
      flex-direction: column;
    }

    .btn-home {
      width: 100%;
    }
  }
</style>

<div class="result-container">
  {% if submission.score is not none and max_score > 0 %}
    {% if submission.score >= (max_score * pass_percent) %}
      <!-- ===== PASS STATE ===== -->
      <div class="result-card-pass">
        <div class="pass-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 6L9 17L4 12" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <h1 class="pass-title">üéâ Congratulations!</h1>
        <p class="pass-subtitle">You passed this exam</p>

        <!-- Score Card -->
        <div class="score-card">
          <div class="score-display">
            <div class="score-item">
              <div class="score-label">Your Score</div>
              <div class="score-value">{{ submission.score|int }}</div>
            </div>
            <div class="score-divider"></div>
            <div class="score-item">
              <div class="score-label">Total Points</div>
              <div class="score-value">{{ max_score|int }}</div>
            </div>
            <div class="score-divider"></div>
            <div class="score-item">
              <div class="score-label">Percentage</div>
              <div class="score-percentage">
                {% if max_score > 0 %}
                  {{ ((submission.score / max_score) * 100)|round(1) }}%
                {% else %}
                  N/A
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Exam Info -->
        <div class="exam-info">
          <div class="info-row">
            <span class="info-label"><i class="fas fa-book-open"></i> Exam Title</span>
            <span class="info-value">{{ exam.title }}</span>
          </div>
          <div class="info-row">
            <span class="info-label"><i class="fas fa-graduation-cap"></i> Programme</span>
            <span class="info-value">{{ exam.programme_name }} ‚Äî Level {{ exam.programme_level }}</span>
          </div>
          {% if set_name %}
            <div class="info-row">
              <span class="info-label"><i class="fas fa-list-check"></i> Question Set</span>
              <span class="info-value">{{ set_name }}</span>
            </div>
          {% endif %}
          <div class="info-row">
            <span class="info-label"><i class="fas fa-calendar-alt"></i> Submitted</span>
            <span class="info-value">
              {% if submission.submitted_at %}
                {{ submission.submitted_at.strftime("%b %d, %Y at %I:%M %p") }}
              {% else %}
                Not submitted
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Buttons -->
        <div class="button-group">
          <a href="{{ url_for('exam.exams') }}" class="btn-home">
            <i class="fas fa-home"></i> Return to My Exams
          </a>
        </div>
      </div>

    {% else %}
      <!-- ===== FAIL STATE ===== -->
      <div class="result-card-fail">
        <div class="fail-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 8L16 16M16 8L8 16" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="10" fill="none" stroke="white" stroke-width="1.5" opacity="0.3"/>
          </svg>
        </div>

        <h1 class="fail-title">Need Improvement</h1>
        <p class="fail-subtitle">You did not pass this exam</p>

        <div class="fail-hint">
          <strong><i class="fas fa-lightbulb"></i> Tip:</strong> Review the course material and try again. You can attempt this exam multiple times to improve your score.
        </div>

        <!-- Score Card -->
        <div class="score-card">
          <div class="score-display">
            <div class="score-item">
              <div class="score-label">Your Score</div>
              <div class="score-value">{{ submission.score|int }}</div>
            </div>
            <div class="score-divider"></div>
            <div class="score-item">
              <div class="score-label">Passing Score</div>
              <div class="score-value">{{ (max_score * pass_percent)|int }}</div>
            </div>
            <div class="score-divider"></div>
            <div class="score-item">
              <div class="score-label">Percentage</div>
              <div class="score-percentage">
                {% if max_score > 0 %}
                  {{ ((submission.score / max_score) * 100)|round(1) }}%
                {% else %}
                  N/A
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Exam Info -->
        <div class="exam-info">
          <div class="info-row">
            <span class="info-label"><i class="fas fa-book-open"></i> Exam Title</span>
            <span class="info-value">{{ exam.title }}</span>
          </div>
          <div class="info-row">
            <span class="info-label"><i class="fas fa-graduation-cap"></i> Programme</span>
            <span class="info-value">{{ exam.programme_name }} ‚Äî Level {{ exam.programme_level }}</span>
          </div>
          {% if set_name %}
            <div class="info-row">
              <span class="info-label"><i class="fas fa-list-check"></i> Question Set</span>
              <span class="info-value">{{ set_name }}</span>
            </div>
          {% endif %}
          <div class="info-row">
            <span class="info-label"><i class="fas fa-calendar-alt"></i> Submitted</span>
            <span class="info-value">
              {% if submission.submitted_at %}
                {{ submission.submitted_at.strftime("%b %d, %Y at %I:%M %p") }}
              {% else %}
                Not submitted
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Buttons -->
        <div class="button-group">
          <a href="{{ url_for('exam.exams') }}" class="btn-home">
            <i class="fas fa-arrow-left"></i> Back to Exams
          </a>
        </div>
      </div>

      <!-- Particle Canvas for Fail Animation -->
      <canvas id="particle-canvas"></canvas>
    {% endif %}

  {% else %}
    <!-- ===== UNGRADED STATE ===== -->
    <div class="result-card-fail">
      <div style="font-size: 3rem; margin-bottom: 1.5rem;">‚è≥</div>
      <h1 class="fail-title">Exam Submitted</h1>
      <p class="fail-subtitle">Your exam is being processed</p>

      <div class="fail-hint">
        <strong><i class="fas fa-info-circle"></i> Status:</strong> Your attempt has been submitted and is awaiting grading. Check back shortly for your results.
      </div>

      <!-- Exam Info -->
      <div class="exam-info">
        <div class="info-row">
          <span class="info-label"><i class="fas fa-book-open"></i> Exam Title</span>
          <span class="info-value">{{ exam.title }}</span>
        </div>
        <div class="info-row">
          <span class="info-label"><i class="fas fa-graduation-cap"></i> Programme</span>
          <span class="info-value">{{ exam.programme_name }} ‚Äî Level {{ exam.programme_level }}</span>
        </div>
        <div class="info-row">
          <span class="info-label"><i class="fas fa-calendar-alt"></i> Submitted</span>
          <span class="info-value">Just now</span>
        </div>
      </div>

      <!-- Buttons -->
      <div class="button-group">
        <a href="{{ url_for('exam.exams') }}" class="btn-home">
          <i class="fas fa-home"></i> Return to My Exams
        </a>
      </div>
    </div>
  {% endif %}
</div>

<!-- ===== CONFETTI ANIMATION (PASS) ===== -->
{% if submission.score is not none and max_score > 0 and submission.score >= (max_score * pass_percent) %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
  function fireConfetti() {
    const duration = 3000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

    function randomInRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = Math.max(0, 50 * (timeLeft / duration));
      // since particles fall down, start a bit higher than random
      confetti(Object.assign({}, defaults, { 
        particleCount,
        origin: { x: randomInRange(0.1, 0.9), y: Math.random() - 0.2 }
      }));
    }, 250);
  }

  window.addEventListener('load', () => {
    setTimeout(fireConfetti, 600);
  });
</script>
{% endif %}

<!-- ===== PARTICLE EFFECT (FAIL) ===== -->
{% if submission.score is not none and max_score > 0 and submission.score < (max_score * pass_percent) %}
<script>
(function() {
  const canvas = document.getElementById('particle-canvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  let particles = [];
  const colors = ['#ff6b6b', '#e63946', '#ff8fa3', '#ff7675'];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  function createParticle(x, y) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 3 + 2;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: Math.random() * 8 + 4,
      rotation: Math.random() * Math.PI * 2,
      vrot: (Math.random() - 0.5) * 0.2,
      color: colors[Math.floor(Math.random() * colors.length)],
      life: 1,
      decay: Math.random() * 0.015 + 0.01
    });
  }

  function drawX(p) {
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rotation);
    ctx.strokeStyle = p.color;
    ctx.lineWidth = p.size * 0.15;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(-p.size / 2, -p.size / 2);
    ctx.lineTo(p.size / 2, p.size / 2);
    ctx.moveTo(p.size / 2, -p.size / 2);
    ctx.lineTo(-p.size / 2, p.size / 2);
    ctx.stroke();
    ctx.restore();
  }

  let animationId;
  let spawnCount = 0;
  let lastSpawnTime = Date.now();

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Spawn particles for first 1.5 seconds
    if (Date.now() - lastSpawnTime < 1500) {
      if (Math.random() < 0.4 && spawnCount < 80) {
        const x = Math.random() * canvas.width;
        const y = -20;
        createParticle(x, y);
        spawnCount++;
      }
    }

    // Update and draw particles
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.15; // gravity
      p.rotation += p.vrot;
      p.life -= p.decay;

      drawX(p);

      if (p.life <= 0 || p.y > canvas.height + 100) {
        particles.splice(i, 1);
      }
    }

    if (particles.length > 0 || spawnCount < 80) {
      animationId = requestAnimationFrame(animate);
    }
  }

  window.addEventListener('load', () => {
    setTimeout(() => {
      lastSpawnTime = Date.now();
      animate();
    }, 400);
  });
})();
</script>
{% endif %}

{% endblock %}