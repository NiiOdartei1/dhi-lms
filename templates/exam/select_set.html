{% extends 'exam/base_exam.html' %}
{% block title %}Choose Set for {{ exam.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="mb-4">
    <a href="{{ url_for('exam.exams') }}" class="btn btn-outline-secondary btn-sm mb-3">
      <i class="fas fa-arrow-left"></i> Back to Exams
    </a>
    <h2 class="mb-1"><i class="fas fa-list-check"></i> Select Your Exam Set</h2>
    <p class="text-muted">Choose which set of questions you'll answer for this exam</p>
  </div>

  <!-- Exam Info Card -->
  <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h5 class="card-title mb-3"><i class="fas fa-book-open"></i> {{ exam.title }}</h5>
          <p class="mb-2">
            <small>
              <strong>Course:</strong> {{ exam.course.code }} â€” {{ exam.course.name }}
            </small>
          </p>
          <p class="mb-2">
            <small>
              <strong>Programme:</strong> {{ exam.programme_name }} (Level {{ exam.programme_level }})
            </small>
          </p>
          <p class="mb-0">
            <small>
              <strong>Scheduled:</strong> {{ exam.start_datetime.strftime("%b %d, %Y at %H:%M") }}
            </small>
          </p>
        </div>
        <div class="col-md-4 text-end">
          <div class="mb-2">
            <small class="opacity-75">Duration</small><br>
            <span style="font-size: 1.5rem; font-weight: bold;">
              {% if exam.duration_minutes >= 60 %}
                {{ (exam.duration_minutes / 60)|int }}h {{ exam.duration_minutes % 60 }}m
              {% else %}
                {{ exam.duration_minutes }}m
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Set Selection Card -->
  <div class="card shadow-lg border-0">
    <div class="card-header text-white" style="background: linear-gradient(90deg, #4e73df, #1cc88a);">
      <h5 class="mb-0"><i class="fas fa-clone"></i> Available Question Sets</h5>
    </div>

    <div class="card-body">
      {% if sets %}
        <p class="text-muted mb-4">
          <i class="fas fa-info-circle"></i> 
          <small>You will be randomly assigned one of these sets if not selected. Choose carefully as you cannot change your selection once you start.</small>
        </p>

        <form method="POST" id="setForm">
          <!-- CSRF token -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="row g-3">
            {% for s in sets %}
              <div class="col-md-6">
                <div class="set-card card h-100 border-2" style="cursor: pointer; transition: all 0.3s ease;" onclick="selectSet('set-{{ s.id }}')">
                  <div class="card-body">
                    <div class="form-check mb-0">
                      <input class="form-check-input set-radio" type="radio" name="set_id" id="set-{{ s.id }}" value="{{ s.id }}" {% if loop.first %}checked{% endif %}>
                      <label class="form-check-label flex-grow-1" for="set-{{ s.id }}" style="cursor: pointer;">
                        <strong>{{ s.name }}</strong>
                      </label>
                    </div>
                    
                    {% if s.max_score %}
                      <div class="mt-3 pt-3 border-top">
                        <small class="text-muted d-block mb-2">
                          <i class="fas fa-star"></i> Total Marks
                        </small>
                        <h6 class="text-primary mb-0">{{ s.max_score }} points</h6>
                      </div>
                    {% endif %}

                    {% if s.question_count %}
                      <div class="mt-3">
                        <small class="text-muted d-block">
                          <i class="fas fa-question-circle"></i> Questions
                        </small>
                        <h6 class="mb-0">{{ s.question_count }} questions</h6>
                      </div>
                    {% endif %}
                  </div>
                  <div class="card-footer bg-light border-top-0">
                    <small class="text-muted">Click to select this set</small>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-success btn-lg flex-grow-1">
              <i class="fas fa-arrow-right-circle"></i> Proceed to Instructions
            </button>
            <a href="{{ url_for('exam.exams') }}" class="btn btn-outline-secondary btn-lg">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
        </form>

      {% else %}
        <!-- No Sets Available -->
        <div class="text-center py-5">
          <div style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;">
            <i class="fas fa-inbox"></i>
          </div>
          <h5 class="text-muted">No Question Sets Available</h5>
          <p class="text-muted">The instructor has not yet created question sets for this exam.</p>
          <p class="text-muted small">Please contact your instructor or try again later.</p>
          <a href="{{ url_for('exam.exams') }}" class="btn btn-outline-secondary mt-3">
            <i class="fas fa-arrow-left"></i> Back to Exams
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Info Box -->
  {% if sets %}
    <div class="alert alert-warning mt-4" role="alert">
      <i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> 
      Once you select a set and proceed, you cannot change it. Make sure you've chosen the correct set before starting the exam.
    </div>
  {% endif %}
</div>

<!-- Styles -->
<style>
  .set-card {
    border-color: #ddd;
  }

  .set-card:hover {
    border-color: #4e73df;
    box-shadow: 0 0.5rem 1rem rgba(78, 115, 223, 0.15);
    transform: translateY(-2px);
  }

  .set-card.selected {
    border-color: #1cc88a;
    background-color: #f0fdf4;
    box-shadow: 0 0.5rem 1rem rgba(28, 200, 138, 0.15);
  }

  .form-check-input {
    cursor: pointer;
    width: 1.3rem;
    height: 1.3rem;
  }

  .form-check-label {
    cursor: pointer;
    padding: 0.25rem 0;
  }

  @media (max-width: 768px) {
    .btn-lg {
      padding: 0.65rem 1rem;
      font-size: 0.95rem;
    }
  }
</style>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const setRadios = document.querySelectorAll('.set-radio');
  const setCards = document.querySelectorAll('.set-card');

  // Handle radio button changes
  setRadios.forEach(radio => {
    radio.addEventListener('change', function () {
      updateCardSelection();
    });
  });

  // Make entire card clickable
  setCards.forEach(card => {
    const radio = card.querySelector('.set-radio');
    card.addEventListener('click', function (e) {
      if (e.target !== radio) {
        radio.click();
      }
    });
  });

  // Update card styling when selection changes
  function updateCardSelection() {
    setCards.forEach(card => {
      const radio = card.querySelector('.set-radio');
      if (radio.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
  }

  // Initialize on load
  updateCardSelection();
});

// Helper function for onclick
function selectSet(id) {
  document.getElementById(id).click();
}
</script>

{% endblock %}