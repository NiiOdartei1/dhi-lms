{% extends "admin/layout.html" %}
{% block title %}Result Vetting Details{% endblock %}

{% block content %}
<style>
  .results-container { font-size: 0.9rem; }
  .results-card {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(200,200,200,0.3);
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: 0.3s ease;
    margin-bottom: 1rem;
  }
  .results-card:hover { box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
  .table th, .table td { padding: 0.45rem 0.75rem !important; vertical-align: middle; font-size: 0.85rem; }
  .table thead { background: #0d6efd; color: white; text-transform: uppercase; }
  .nav-tabs .nav-link { font-size: 0.85rem; font-weight: 600; color: #555; }
  .nav-tabs .nav-link.active { color: #0d6efd; background: #f8f9fa; border-bottom: 2px solid #0d6efd; }
  .filter-bar input, .filter-bar select { font-size: 0.85rem; }
  .course-section { margin-bottom: 2rem; }
  .course-header { 
    background: linear-gradient(135deg, #0d6efd 0%, #0d5ae8 100%);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }
  .score-good { color: #28a745; font-weight: 600; }
  .score-warning { color: #ffc107; font-weight: 600; }
  .score-danger { color: #dc3545; font-weight: 600; }
  .badge-sm { font-size: 0.75rem; }
  .empty-state {
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    border-radius: 0.5rem;
    color: #999;
  }
</style>

<div class="container-fluid py-2 results-container">
  <!-- Hidden CSRF Token -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  
  <!-- Header --> 
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1">
        <i class="fas fa-check-circle me-2"></i> Vetting Details
      </h4>
      <p class="text-muted mb-0">
        <strong>{{ release.academic_year|start_year }} - {{ release.semester }} Semester</strong>
        {% if release.is_released %}
          <span class="badge bg-success ms-2">âœ“ Released</span>
        {% elif release.is_locked %}
          <span class="badge bg-warning text-dark ms-2">ðŸ”’ Locked for Vetting</span>
        {% endif %}
        <br>
        <small>Submitted: {{ release.locked_at.strftime("%Y-%m-%d %H:%M") if release.locked_at else release.created_at.strftime("%Y-%m-%d %H:%M") }}</small>
      </p>
    </div>
    <div class="btn-group" role="group">
      <a href="{{ url_for('admin.result_vetting_list') }}" class="btn btn-sm btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to List
      </a>
      {% if not release.is_released %}
      <button class="btn btn-sm btn-success" onclick="approveResults()">
        <i class="fas fa-check me-1"></i> Approve & Release
      </button>
      <button class="btn btn-sm btn-danger" onclick="rejectResults()">
        <i class="fas fa-times me-1"></i> Reject / Unlock
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Debug Info (remove in production) -->
  {% if not course_details or course_details|length == 0 %}
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>No course data available for vetting.</strong>
      <details class="mt-2">
        <summary>Debug Info</summary>
        <div class="small mt-2 bg-light p-2 rounded">
          <p><strong>Submitted Courses Count:</strong> {{ submitted_courses|length }}</p>
          <p><strong>Submitted Courses:</strong> {{ submitted_courses|safe }}</p>
          <p><strong>Course Details Count:</strong> {{ course_details|length }}</p>
          <p><strong>Release ID:</strong> {{ release.id }}</p>
          <p><strong>Parsed Courses:</strong></p>
          <ul>
            {% for c in submitted_courses %}
              <li>{{ c }}</li>
            {% else %}
              <li><em>None</em></li>
            {% endfor %}
          </ul>
        </div>
      </details>
    </div>
  {% else %}

    <!-- Filters -->
    <div class="row mb-3 g-2 filter-bar align-items-center">
      <div class="col-md-4 col-12">
        <input type="text" id="searchStudent" class="form-control form-control-sm" placeholder="Search student name...">
      </div>
      <div class="col-md-4 col-12">
        <select id="filterCourse" class="form-select form-select-sm">
          <option value="">All Courses</option>
          {% for detail in course_details %}
            {% if detail.course %}
            <option value="{{ detail.course.name or detail.course.code }}">
              {{ detail.course.code }} - {{ detail.course.name }}
            </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-12 text-md-end text-center">
        <button class="btn btn-sm btn-outline-secondary" id="resetFilters">
          <i class="fas fa-undo me-1"></i> Reset
        </button>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4 g-2">
      {% set total_quizzes = course_details|map(attribute='quizzes')|map('length')|sum %}
      {% set total_exams = course_details|map(attribute='exams')|map('length')|sum %}
      {% set total_assignments = course_details|map(attribute='assignments')|map('length')|sum %}
      
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <h6 class="text-muted mb-0">Courses</h6>
            <h3 class="text-primary mb-0">{{ course_details|length }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <h6 class="text-muted mb-0">Quiz Submissions</h6>
            <h3 class="text-info mb-0">{{ total_quizzes }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <h6 class="text-muted mb-0">Exam Submissions</h6>
            <h3 class="text-success mb-0">{{ total_exams }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body py-2">
            <h6 class="text-muted mb-0">Assignment Submissions</h6>
            <h3 class="text-warning mb-0">{{ total_assignments }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Results by Course -->
    {% for detail in course_details %}
      {% if detail.course %}
      <div class="course-section" data-course="{{ detail.course.code }} - {{ detail.course.name }}">
        <div class="course-header">
          <h5 class="mb-0">
            <i class="fas fa-book me-2"></i>
            {{ detail.course.code }} - {{ detail.course.name }}
          </h5>
        </div>

        <!-- Tabs: Quiz / Exam / Assignment -->
        {% set has_quizzes = detail.quizzes|length > 0 %}
        {% set has_exams = detail.exams|length > 0 %}
        {% set has_assignments = detail.assignments|length > 0 %}

        {% if not has_quizzes and not has_exams and not has_assignments %}
          <div class="empty-state">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <p>No submissions for this course</p>
          </div>
        {% else %}

        <ul class="nav nav-tabs mb-2" id="typeTabs-{{ detail.course.id }}" role="tablist">
          {% if has_quizzes %}
          <li class="nav-item">
            <button class="nav-link {% if loop.first %}active{% endif %}" 
                    id="quiz-tab-{{ detail.course.id }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#quiz-pane-{{ detail.course.id }}" 
                    type="button" role="tab">
              <i class="fas fa-question-circle me-1"></i> Quizzes ({{ detail.quizzes|length }})
            </button>
          </li>
          {% endif %}

          {% if has_exams %}
          <li class="nav-item">
            <button class="nav-link {% if not has_quizzes and loop.first %}active{% endif %}" 
                    id="exam-tab-{{ detail.course.id }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#exam-pane-{{ detail.course.id }}" 
                    type="button" role="tab">
              <i class="fas fa-pencil-alt me-1"></i> Exams ({{ detail.exams|length }})
            </button>
          </li>
          {% endif %}

          {% if has_assignments %}
          <li class="nav-item">
            <button class="nav-link {% if not has_quizzes and not has_exams and loop.first %}active{% endif %}" 
                    id="assign-tab-{{ detail.course.id }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#assign-pane-{{ detail.course.id }}" 
                    type="button" role="tab">
              <i class="fas fa-file-alt me-1"></i> Assignments ({{ detail.assignments|length }})
            </button>
          </li>
          {% endif %}
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="typeTabsContent-{{ detail.course.id }}">
          <!-- QUIZZES -->
          {% if has_quizzes %}
          <div class="tab-pane fade show active" 
               id="quiz-pane-{{ detail.course.id }}" role="tabpanel">
            <div class="results-card p-2">
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle mb-0 student-table">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Quiz</th>
                      <th>Score</th>
                      <th>Percentage</th>
                      <th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for q in detail.quizzes %}
                    <tr data-student="{{ q.student_name|lower }}" data-course="{{ detail.course.code }}">
                      <td>{{ q.student_name }}</td>
                      <td>{{ q.quiz_title or 'Quiz' }}</td>
                      <td>
                        {% if q.max_score %}
                          <span class="{% if q.score / q.max_score >= 0.7 %}score-good{% elif q.score / q.max_score >= 0.5 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.2f"|format(q.score) }}/{{ "%.2f"|format(q.max_score) }}
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if q.max_score and q.max_score > 0 %}
                          {% set pct = q.score / q.max_score * 100 %}
                          <span class="{% if pct >= 70 %}score-good{% elif pct >= 50 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.1f"|format(pct) }}%
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td><small>{{ q.submitted_at.strftime("%Y-%m-%d %H:%M") if q.submitted_at else '-' }}</small></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- EXAMS -->
          {% if has_exams %}
          <div class="tab-pane fade {% if not has_quizzes %}show active{% endif %}" 
               id="exam-pane-{{ detail.course.id }}" role="tabpanel">
            <div class="results-card p-2">
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle mb-0 student-table">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Exam</th>
                      <th>Score</th>
                      <th>Percentage</th>
                      <th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in detail.exams %}
                    <tr data-student="{{ e.student_name|lower }}" data-course="{{ detail.course.code }}">
                      <td>{{ e.student_name }}</td>
                      <td>{{ e.exam_title or 'Exam' }}</td>
                      <td>
                        {% if e.max_score %}
                          <span class="{% if e.score / e.max_score >= 0.7 %}score-good{% elif e.score / e.max_score >= 0.5 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.2f"|format(e.score) }}/{{ "%.2f"|format(e.max_score) }}
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if e.max_score and e.max_score > 0 %}
                          {% set pct = e.score / e.max_score * 100 %}
                          <span class="{% if pct >= 70 %}score-good{% elif pct >= 50 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.1f"|format(pct) }}%
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td><small>{{ e.submitted_at.strftime("%Y-%m-%d %H:%M") if e.submitted_at else '-' }}</small></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ASSIGNMENTS -->
          {% if has_assignments %}
          <div class="tab-pane fade {% if not has_quizzes and not has_exams %}show active{% endif %}" 
               id="assign-pane-{{ detail.course.id }}" role="tabpanel">
            <div class="results-card p-2">
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle mb-0 student-table">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Assignment</th>
                      <th>Score</th>
                      <th>Percentage</th>
                      <th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for a in detail.assignments %}
                    <tr data-student="{{ a.student_name|lower }}" data-course="{{ detail.course.code }}">
                      <td>{{ a.student_name }}</td>
                      <td>{{ a.assignment_title or 'Assignment' }}</td>
                      <td>
                        {% if a.max_score %}
                          <span class="{% if a.score / a.max_score >= 0.7 %}score-good{% elif a.score / a.max_score >= 0.5 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.2f"|format(a.score) }}/{{ "%.2f"|format(a.max_score) }}
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if a.max_score and a.max_score > 0 %}
                          {% set pct = a.score / a.max_score * 100 %}
                          <span class="{% if pct >= 70 %}score-good{% elif pct >= 50 %}score-warning{% else %}score-danger{% endif %}">
                            {{ "%.1f"|format(pct) }}%
                          </span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td><small>{{ a.submitted_at.strftime("%Y-%m-%d %H:%M") if a.submitted_at else '-' }}</small></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    {% endfor %}

  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchStudent');
  const courseFilter = document.getElementById('filterCourse');
  const resetBtn = document.getElementById('resetFilters');

  if (searchInput && courseFilter && resetBtn) {
    function applyFilters() {
      const search = searchInput.value.toLowerCase();
      const course = courseFilter.value;
      
      document.querySelectorAll('table tbody tr').forEach(row => {
        const student = (row.dataset.student || '').toLowerCase();
        const rowCourse = row.dataset.course || '';
        const visible =
          (!search || student.includes(search)) &&
          (!course || rowCourse.includes(course));
        row.style.display = visible ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', applyFilters);
    courseFilter.addEventListener('change', applyFilters);
    resetBtn.addEventListener('click', () => {
      searchInput.value = '';
      courseFilter.value = '';
      applyFilters();
    });
  }
});

async function approveResults() {
  const academicYear = '{{ release.academic_year|start_year }}';
  const semester = '{{ release.semester }}';
  const csrfToken = document.querySelector('input[name="csrf_token"]').value;
  
  if (!confirm(`Approve and release results for ${academicYear} ${semester}?`)) return;
  
  try {
    const response = await fetch('{{ url_for("admin.api_approve_results") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({academic_year: academicYear, semester: semester})
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('âœ“ Results approved and released to students.');
      window.location.href = '{{ url_for("admin.result_vetting_list") }}';
    } else {
      alert('Failed: ' + (data.message || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function rejectResults() {
  const academicYear = '{{ release.academic_year|start_year }}';
  const semester = '{{ release.semester }}';
  const csrfToken = document.querySelector('input[name="csrf_token"]').value;
  
  if (!confirm(`Unlock ${academicYear} ${semester}? Teachers will be able to edit grades again.`)) return;
  
  try {
    const response = await fetch('{{ url_for("admin.api_reject_results") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({academic_year: academicYear, semester: semester})
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('âœ“ Semester unlocked. Teachers can now edit grades.');
      window.location.href = '{{ url_for("admin.result_vetting_list") }}';
    } else {
      alert('Failed: ' + (data.message || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}
</script>
{% endblock %}
