{% extends "admin/layout.html" %}

{% block content %}
<div class="container-fluid py-1">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="fw-bold text-dark mb-1">Semester Grading Details</h2>
          <p class="text-muted mb-0">
            <span class="badge bg-info">{{ academic_year|start_year }}</span>
            <span class="badge bg-secondary">{{ semester }} Semester</span>
          </p>
        </div>
        <div>
          <a href="{{ url_for('grading.manage_grading') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-muted small mb-2">Total Grades</p>
          <h3 class="fw-bold text-primary mb-0">{{ summary['total_grades'] }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-muted small mb-2">Finalized</p>
          <h3 class="fw-bold text-success mb-0">{{ summary['finalized_count'] }}</h3>
          {% if summary['total_grades'] > 0 %}
          <small class="text-muted">{{ ((summary['finalized_count'] / summary['total_grades']) * 100)|round(1) }}%</small>
          {% else %}
          <small class="text-muted">0%</small>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-muted small mb-2">Released</p>
          <h3 class="fw-bold text-info mb-0">{{ summary['released_count'] }}</h3>
          {% if summary['total_grades'] > 0 %}
          <small class="text-muted">{{ ((summary['released_count'] / summary['total_grades']) * 100)|round(1) }}%</small>
          {% else %}
          <small class="text-muted">0%</small>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-muted small mb-2">Average GPA</p>
          <h3 class="fw-bold text-warning mb-0">{{ summary['average_gpa']|round(2) }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light border-bottom">
          <h5 class="mb-0 fw-bold">Semester Status</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2">
                <strong>Status:</strong>
                <span class="badge {% if status['is_locked'] %}bg-danger{% elif status['is_released'] %}bg-success{% else %}bg-warning{% endif %}">
                  {% if status['is_locked'] %}
                    üîí Locked
                  {% elif status['is_released'] %}
                    ‚úì Released
                  {% else %}
                    ‚è≥ In Progress
                  {% endif %}
                </span>
              </p>
              <p class="mb-2">
                <strong>Students Affected:</strong> {{ summary['total_students'] }}
              </p>
            </div>
            <div class="col-md-6">
              {% if status['released_at'] %}
              <p class="mb-2">
                <strong>Released At:</strong> {{ status['released_at'].strftime('%d %b %Y %H:%M') if status['released_at'] else 'Not yet' }}
              </p>
              {% endif %}
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex gap-2 flex-wrap">
              <a href="{{ url_for('grading.finalize_semester', academic_year=academic_year, semester=semester) }}" class="btn btn-sm btn-primary">
                <i class="fas fa-check"></i> Finalize Semester
              </a>

              {% if not status['is_released'] %}
              <form method="POST" class="d-inline" action="{{ url_for('grading.release_semester_results', academic_year=academic_year, semester=semester) }}">
                <button type="submit" class="btn btn-sm btn-success">
                  <i class="fas fa-unlock"></i> Release Results
                </button>
              </form>
              {% endif %}

              {% if status['is_released'] %}
              <form method="POST" class="d-inline" action="{{ url_for('grading.recall_semester_results', academic_year=academic_year, semester=semester) }}">
                <button type="submit" class="btn btn-sm btn-warning">
                  <i class="fas fa-redo"></i> Recall Results
                </button>
              </form>
              {% endif %}

              {% if not status['is_locked'] %}
              <form method="POST" class="d-inline" action="{{ url_for('grading.lock_semester', academic_year=academic_year, semester=semester) }}">
                <button type="submit" class="btn btn-sm btn-danger">
                  <i class="fas fa-lock"></i> Lock Semester
                </button>
              </form>
              {% else %}
              <form method="POST" class="d-inline" action="{{ url_for('grading.unlock_semester', academic_year=academic_year, semester=semester) }}">
                <button type="submit" class="btn btn-sm btn-secondary">
                  <i class="fas fa-unlock"></i> Unlock Semester
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Statistics Table -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light border-bottom">
          <h5 class="mb-0 fw-bold">Course Grading Progress</h5>
        </div>
        <div class="card-body p-0">
          {% if course_stats|length > 0 %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-muted">Course Code</th>
                    <th class="text-muted">Course Name</th>
                    <th class="text-muted text-center">Total Students</th>
                    <th class="text-muted text-center">Finalized</th>
                    <th class="text-muted text-center">Released</th>
                    <th class="text-muted text-center">Avg Score</th>
                    <th class="text-muted text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for stat in course_stats %}
                  <tr>
                    <td>
                      <span class="badge bg-light text-dark">{{ stat.course.code }}</span>
                    </td>
                    <td>
                      <strong>{{ stat.course.name }}</strong>
                    </td>
                    <td class="text-center">{{ stat.total_students }}</td>
                    <td class="text-center">
                      <span class="badge {% if stat.finalized_count == stat.total_students %}bg-success{% else %}bg-warning{% endif %}">
                        {{ stat.finalized_count }}/{{ stat.total_students }}
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="badge {% if stat.released_count == stat.total_students %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ stat.released_count }}/{{ stat.total_students }}
                      </span>
                    </td>
                    <td class="text-center fw-bold">{{ stat.average_score|round(1) }}%</td>
                    <td class="text-center">
                      <form method="POST" class="d-inline" action="{{ url_for('grading.finalize_course', course_id=stat.course.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-xs btn-outline-primary" title="Finalize this course">
                          <i class="fas fa-check-circle"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-5 text-center">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted mb-0">No course data available for this semester.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Info Footer -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="alert alert-info border-0 d-flex align-items-center">
        <i class="fas fa-info-circle me-2"></i>
        <small>
          <strong>Workflow:</strong> Finalize all grades ‚Üí Release to students ‚Üí Lock semester when complete.
          Use course actions above to finalize individual courses if needed.
        </small>
      </div>
    </div>
  </div>
</div>

<style>
  .btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }
</style>

{% endblock %}
