{% extends "admin/layout.html" %}
{% block title %}Manage Timetable{% endblock %}

{% block content %}
<style>
  /* Compact sizing */
  .container { padding: 0.5rem; }
  
  .card { margin-bottom: 1rem; }
  
  .card-header { padding: 0.6rem 1rem; }
  
  .card-header h3 { font-size: 1.1rem; margin-bottom: 0; }
  
  .card-header h4 { font-size: 1rem; margin-bottom: 0; }
  
  .card-body { padding: 0.75rem; }
  
  .form-label { font-size: 0.85rem; margin-bottom: 0.25rem; }
  
  .form-control, .form-select { font-size: 0.85rem; padding: 0.35rem 0.6rem; height: 36px; }
  
  .btn { font-size: 0.85rem; padding: 0.35rem 0.75rem; }
  
  .btn-sm { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
  
  .alert { padding: 0.6rem; font-size: 0.9rem; margin-bottom: 0.75rem; }
  
  .row.g-3 { gap: 0.75rem !important; }
  
  .row.g-3 > * { padding-right: 0.375rem; padding-left: 0.375rem; }
  
  .table { font-size: 0.85rem; margin-bottom: 0; }
  
  .table thead { font-size: 0.8rem; }
  
  .table th, .table td { padding: 0.5rem; }
  
  .badge { font-size: 0.75rem; padding: 0.35rem 0.6rem; }
  
  .d-flex.gap-2 { gap: 0.5rem !important; }
  
  #searchBox { font-size: 0.85rem; max-width: 150px; }
  
  #filterDay, #filterProgramme, #filterLevel { font-size: 0.85rem; max-width: 130px; }
  
  .mt-1 { margin-top: 0.5rem; }
  
  .mt-3 { margin-top: 0.75rem; }
  
  .mb-4 { margin-bottom: 1rem; }
  
  .mb-0 { margin-bottom: 0; }
</style>

<div class="container mt-1">
  <!-- Page Header -->
  <div class="card shadow-lg border-0 mb-3">
    <div class="card-header text-white" style="background: linear-gradient(90deg, #4e73df, #36b9cc);">
      <h3 class="mb-0"><i class="fas fa-calendar-alt"></i> Manage Student Timetable</h3>
    </div>
    <div class="card-body">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Timetable Form -->
      <form method="POST" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-md-3 col-sm-6">
          <label for="programme_name" class="form-label fw-bold"><i class="fas fa-graduation-cap"></i> Programme</label>
          <select id="programme_name" class="form-select" name="programme_name" required>
            <option value="">Select Programme</option>
            {% for programme_value, programme_label in programmes %}
              <option value="{{ programme_value }}">{{ programme_label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="programme_level" class="form-label fw-bold"><i class="fas fa-layer-group"></i> Level</label>
          <select id="programme_level" class="form-select" name="programme_level" required>
            <option value="">Select Level</option>
            {% for level_value, level_label in levels %}
              <option value="{{ level_value }}">{{ level_label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3 col-sm-6">
          <label for="course_id" class="form-label fw-bold"><i class="fas fa-book"></i> Course</label>
          <select id="course_id" class="form-select" name="course_id" required>
            <option value="">Select Course</option>
            {% for course in courses %}
              <option value="{{ course.id }}">{{ course.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="day" class="form-label fw-bold"><i class="fas fa-calendar-day"></i> Day</label>
          <select id="day" class="form-select" name="day" required>
            <option value="">Select Day</option>
            {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday'] %}
              <option value="{{ day }}">{{ day }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="start_time" class="form-label fw-bold"><i class="fas fa-clock"></i> Start</label>
          <input id="start_time" type="time" name="start_time" class="form-control" required>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="end_time" class="form-label fw-bold"><i class="fas fa-clock"></i> End</label>
          <input id="end_time" type="time" name="end_time" class="form-control" required>
        </div>

        <div class="col-12 text-end mt-2">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Add Entry
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timetable Table -->
  <div class="card shadow-sm border-0">
    <div class="card-header text-white" style="background: linear-gradient(90deg, #1cc88a, #20c997);">
      <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <h4 class="mb-0" style="font-size: 1rem;"><i class="fas fa-table"></i> Timetable Entries</h4>
        <div class="d-flex gap-2 align-items-center" style="flex-wrap: wrap;">
          <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="ðŸ” Search..." style="font-size: 0.8rem; padding: 0.3rem 0.5rem; max-width: 140px;">
          <select id="filterProgramme" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem; max-width: 120px;">
            <option value="">All Programmes</option>
          </select>
          <select id="filterLevel" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem; max-width: 100px;">
            <option value="">All Levels</option>
            <option>100</option>
            <option>200</option>
            <option>300</option>
            <option>400</option>
          </select>
          <select id="filterDay" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem; max-width: 110px;">
            <option value="">All Days</option>
            <option>Monday</option>
            <option>Tuesday</option>
            <option>Wednesday</option>
            <option>Thursday</option>
            <option>Friday</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0" id="timetableTable">
          <thead class="table-dark">
            <tr>
              <th style="font-size: 0.8rem;">Programme</th>
              <th style="font-size: 0.8rem;">Level</th>
              <th style="font-size: 0.8rem;">Course</th>
              <th style="font-size: 0.8rem;">Day</th>
              <th style="font-size: 0.8rem;">Start</th>
              <th style="font-size: 0.8rem;">End</th>
              <th style="width: 120px; font-size: 0.8rem;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in timetable %}
            <tr data-programme="{{ entry.programme_name }}" data-level="{{ entry.programme_level }}" data-day="{{ entry.day_of_week }}">
              <td><span class="badge bg-primary" style="font-size: 0.7rem;">{{ entry.programme_name }}</span></td>
              <td><span class="badge bg-info" style="font-size: 0.7rem;">{{ entry.programme_level }}</span></td>
              <td style="font-size: 0.85rem;">{{ entry.course.name }}</td>
              <td>
                <span class="badge 
                  {% if entry.day_of_week == 'Monday' %}bg-success
                  {% elif entry.day_of_week == 'Tuesday' %}bg-warning text-dark
                  {% elif entry.day_of_week == 'Wednesday' %}bg-danger
                  {% elif entry.day_of_week == 'Thursday' %}bg-secondary
                  {% else %}bg-info{% endif %}" style="font-size: 0.7rem;">
                  {{ entry.day_of_week }}
                </span>
              </td>
              <td style="font-size: 0.85rem;"><i class="fas fa-clock text-success"></i> {{ entry.start_time.strftime('%H:%M') }}</td>
              <td style="font-size: 0.85rem;"><i class="fas fa-clock text-danger"></i> {{ entry.end_time.strftime('%H:%M') }}</td>
              <td>
                <a href="{{ url_for('admin.edit_timetable_entry', entry_id=entry.id) }}" 
                   class="btn btn-sm btn-warning" title="Edit" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;"><i class="fas fa-edit"></i></a>
                <form action="{{ url_for('admin.delete_timetable_entry', entry_id=entry.id) }}" 
                      method="POST" class="d-inline" 
                      onsubmit="return confirm('Delete this entry?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-danger" title="Delete" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;"><i class="fas fa-trash-alt"></i></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted p-3" style="font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> No timetable entries found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Filtering Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchBox = document.getElementById("searchBox");
  const filterProgramme = document.getElementById("filterProgramme");
  const filterLevel = document.getElementById("filterLevel");
  const filterDay = document.getElementById("filterDay");
  const rows = document.querySelectorAll("#timetableTable tbody tr");

  // Populate programme filter from table data
  const programmes = new Set();
  rows.forEach(row => {
    const prog = row.getAttribute('data-programme');
    if (prog) programmes.add(prog);
  });
  
  programmes.forEach(prog => {
    const option = document.createElement('option');
    option.value = prog;
    option.textContent = prog;
    filterProgramme.appendChild(option);
  });

  function filterTable() {
    const search = searchBox.value.toLowerCase();
    const programme = filterProgramme.value;
    const level = filterLevel.value;
    const day = filterDay.value;

    rows.forEach(row => {
      if (row.cells.length < 7) return; // Skip empty rows
      
      const programmeText = row.getAttribute('data-programme') || '';
      const levelText = row.getAttribute('data-level') || '';
      const dayText = row.getAttribute('data-day') || '';
      const courseText = row.cells[2].innerText.toLowerCase();

      let match = true;
      
      if (search && !(programmeText.toLowerCase().includes(search) || courseText.includes(search))) {
        match = false;
      }
      if (programme && programmeText !== programme) match = false;
      if (level && levelText !== level) match = false;
      if (day && dayText !== day) match = false;

      row.style.display = match ? "" : "none";
    });
  }

  searchBox.addEventListener("keyup", filterTable);
  filterProgramme.addEventListener("change", filterTable);
  filterLevel.addEventListener("change", filterTable);
  filterDay.addEventListener("change", filterTable);
});
</script>
{% endblock %}