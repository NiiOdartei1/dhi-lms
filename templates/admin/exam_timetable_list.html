{% extends "admin/layout.html" %}
{% block title %}Exam Timetable{% endblock %}

{% block content %}
<style>
  .container { padding: 0.5rem; }
  .card { margin-bottom: 1rem; }
  .card-header { padding: 0.6rem 1rem; }
  .card-header h3 { font-size: 1.1rem; margin-bottom: 0; }
  .card-body { padding: 0.75rem; }
  .form-label { font-size: 0.85rem; margin-bottom: 0.25rem; }
  .form-control, .form-select { font-size: 0.85rem; padding: 0.35rem 0.6rem; height: 36px; }
  .btn { font-size: 0.85rem; padding: 0.35rem 0.75rem; }
  .btn-sm { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
  .alert { padding: 0.6rem; font-size: 0.9rem; margin-bottom: 0.75rem; }
  .table { font-size: 0.85rem; margin-bottom: 0; }
  .table thead { font-size: 0.8rem; }
  .table th, .table td { padding: 0.5rem; }
  .badge { font-size: 0.75rem; padding: 0.35rem 0.6rem; }
  #searchBox, #filterProgramme, #filterLevel, #filterSemester { font-size: 0.85rem; max-width: 130px; }
</style>

<div class="container mt-1">
  <!-- Page Header -->
  <div class="card shadow-lg border-0 mb-3">
    <div class="card-header text-white" style="background: linear-gradient(90deg, #4e73df, #36b9cc);">
      <h3 class="mb-0"><i class="fas fa-calendar-alt"></i> Exam Timetable</h3>
    </div>
    <div class="card-body">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Exam Timetable Form -->
      <form method="POST" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-md-2 col-sm-6">
          <label for="programme_name" class="form-label fw-bold"><i class="fas fa-graduation-cap"></i> Programme</label>
          <select id="programme_name" class="form-select" name="programme_name" required>
            <option value="">Select Programme</option>
            {% for p in programmes %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="programme_level" class="form-label fw-bold"><i class="fas fa-layer-group"></i> Level</label>
          <select id="programme_level" class="form-select" name="programme_level" required>
            <option value="">Select Level</option>
            {% for lvl in levels %}
              <option value="{{ lvl }}">{{ lvl }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="course" class="form-label fw-bold"><i class="fas fa-book"></i> Course</label>
          <select id="course" name="course" class="form-select" required>
            <option value="">Select Course</option>
            {% for c in courses %}
              <option value="{{ c.code }}" data-programme="{{ c.programme_name }}" data-level="{{ c.programme_level }}" data-semester="{{ c.semester }}">{{ c.code }} - {{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="semester" class="form-label fw-bold"><i class="fas fa-calendar-check"></i> Semester</label>
          <select id="semester" name="semester" class="form-select">
            <option value="">Auto (from course)</option>
            {% for s in semesters %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="date" class="form-label fw-bold"><i class="fas fa-calendar"></i> Date</label>
          <input id="date" type="date" name="date" class="form-control" required>
        </div>

        <div class="col-md-1 col-sm-6">
          <label for="start_time" class="form-label fw-bold"><i class="fas fa-clock"></i> Start</label>
          <input id="start_time" type="time" name="start_time" class="form-control" required>
        </div>

        <div class="col-md-1 col-sm-6">
          <label for="end_time" class="form-label fw-bold"><i class="fas fa-clock"></i> End</label>
          <input id="end_time" type="time" name="end_time" class="form-control" required>
        </div>

        <!-- Row Break -->
        <div class="col-12"></div>

        <div class="col-md-2 col-sm-6">
          <label for="room" class="form-label fw-bold"><i class="fas fa-door-open"></i> Room</label>
          <input id="room" type="text" name="room" class="form-control" placeholder="e.g., A101" required>
        </div>

        <div class="col-md-3 col-sm-6">
          <label for="building" class="form-label fw-bold"><i class="fas fa-building"></i> Building</label>
          <input id="building" type="text" name="building" class="form-control" placeholder="e.g., A">
        </div>

        <div class="col-md-2 col-sm-6">
          <label for="floor" class="form-label fw-bold"><i class="fas fa-arrow-up"></i> Floor</label>
          <input id="floor" type="text" name="floor" class="form-control" placeholder="e.g., 1">
        </div>

        <div class="col-md-5 col-sm-12">
          <label for="notes" class="form-label fw-bold"><i class="fas fa-sticky-note"></i> Notes</label>
          <textarea id="notes" name="notes" class="form-control" placeholder="Additional notes..." style="height: 36px;"></textarea>
        </div>

        <div class="col-12 text-end mt-2">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Add Entry
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Exam Timetable Table -->
  <div class="card shadow-sm border-0">
    <div class="card-header text-white" style="background: linear-gradient(90deg, #1cc88a, #20c997);">
      <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <h4 class="mb-0" style="font-size: 1rem;"><i class="fas fa-table"></i> Exam Timetable</h4>
        <div class="d-flex gap-2 align-items-center" style="flex-wrap: wrap;">
          <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="ðŸ” Search..." style="font-size: 0.8rem; padding: 0.3rem 0.5rem;">
          <select id="filterProgramme" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem;">
            <option value="">All Programmes</option>
            {% for p in programmes %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
          <select id="filterLevel" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem;">
            <option value="">All Levels</option>
            {% for lvl in levels %}
              <option value="{{ lvl }}">{{ lvl }}</option>
            {% endfor %}
          </select>
          <select id="filterSemester" class="form-select form-select-sm" style="font-size: 0.8rem; padding: 0.3rem 0.5rem;">
            <option value="">All Semesters</option>
            {% for s in semesters %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0" id="timetableTable">
          <thead class="table-dark">
            <tr>
              <th style="font-size: 0.8rem;">Course</th>
              <th style="font-size: 0.8rem;">Programme</th>
              <th style="font-size: 0.8rem;">Level</th>
              <th style="font-size: 0.8rem;">Semester</th>
              <th style="font-size: 0.8rem;">Date</th>
              <th style="font-size: 0.8rem;">Start</th>
              <th style="font-size: 0.8rem;">End</th>
              <th style="font-size: 0.8rem;">Room</th>
              <th style="width: 120px; font-size: 0.8rem;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in entries %}
            <tr data-course="{{ entry.course }}" data-programme="{{ entry.programme_name }}" data-level="{{ entry.programme_level }}" data-semester="{{ (courses_map[entry.course]['semester'] if entry.course in courses_map else '') }}">
              <td style="font-size: 0.85rem;">{{ entry.course }}</td>
              <td><span class="badge bg-primary" style="font-size: 0.7rem;">{{ entry.programme_name }}</span></td>
              <td><span class="badge bg-info" style="font-size: 0.7rem;">{{ entry.programme_level }}</span></td>
              <td><span class="badge bg-secondary" style="font-size: 0.7rem;">{{ (courses_map[entry.course]['semester'] if entry.course in courses_map else 'N/A') }}</span></td>
              <td style="font-size: 0.85rem;">{{ entry.date.strftime('%Y-%m-%d') }}</td>
              <td style="font-size: 0.85rem;"><i class="fas fa-clock text-success"></i> {{ entry.start_time.strftime('%H:%M') }}</td>
              <td style="font-size: 0.85rem;"><i class="fas fa-clock text-danger"></i> {{ entry.end_time.strftime('%H:%M') }}</td>
              <td style="font-size: 0.85rem;">{{ entry.room or 'N/A' }}</td>
              <td>
                <a href="{{ url_for('admin.edit_exam_timetable_entry', entry_id=entry.id) }}" 
                   class="btn btn-sm btn-warning" title="Edit" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;"><i class="fas fa-edit"></i></a>
                <form action="{{ url_for('admin.delete_exam_timetable_entry', entry_id=entry.id) }}" 
                      method="POST" class="d-inline" 
                      onsubmit="return confirm('Delete this entry?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-danger" title="Delete" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;"><i class="fas fa-trash-alt"></i></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted p-3" style="font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> No exam timetable entries found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Filtering Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchBox = document.getElementById("searchBox");
  const filterProgramme = document.getElementById("filterProgramme");
  const filterLevel = document.getElementById("filterLevel");
  const filterSemester = document.getElementById("filterSemester");
  const rows = document.querySelectorAll("#timetableTable tbody tr");

  // Course select filtering (client-side) â€” keep all options in DOM and show/hide
  const courseSelect = document.getElementById('course');
  const courseOptions = Array.from(courseSelect ? courseSelect.options : []);

  function filterCourseOptions() {
    const prog = document.getElementById('programme_name').value;
    const lvl = document.getElementById('programme_level').value;
    const sem = document.getElementById('semester').value;

    courseOptions.forEach(opt => {
      if (!opt.dataset || !opt.dataset.programme) return;
      let show = true;
      if (prog && opt.dataset.programme !== prog) show = false;
      if (lvl && opt.dataset.level !== lvl) show = false;
      if (sem && opt.dataset.semester !== sem) show = false;
      opt.style.display = show ? '' : 'none';
    });
  }

  if (document.getElementById('programme_name')) document.getElementById('programme_name').addEventListener('change', filterCourseOptions);
  if (document.getElementById('programme_level')) document.getElementById('programme_level').addEventListener('change', filterCourseOptions);
  if (document.getElementById('semester')) document.getElementById('semester').addEventListener('change', filterCourseOptions);
  // run once on load
  filterCourseOptions();

  function filterTable() {
    const search = searchBox.value.toLowerCase();
    const programme = filterProgramme.value;
    const level = filterLevel.value;
    const semester = filterSemester ? filterSemester.value : '';

    rows.forEach(row => {
      if (row.cells.length < 8) return; // Skip empty rows
      
      const programmeText = row.getAttribute('data-programme') || '';
      const levelText = row.getAttribute('data-level') || '';
      const courseText = row.getAttribute('data-course') || '';
      const semesterText = row.getAttribute('data-semester') || '';

      let match = true;
      
      if (search && !courseText.toLowerCase().includes(search)) {
        match = false;
      }
      if (programme && programmeText !== programme) match = false;
      if (level && levelText !== level) match = false;
      if (semester && semesterText !== semester) match = false;

      row.style.display = match ? "" : "none";
    });
  }

  searchBox.addEventListener("keyup", filterTable);
  filterProgramme.addEventListener("change", filterTable);
  filterLevel.addEventListener("change", filterTable);
  if (filterSemester) filterSemester.addEventListener("change", filterTable);
});
</script>
{% endblock %}
