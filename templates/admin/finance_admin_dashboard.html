{% extends 'admin/layout.html' %}
{% block title %}Finance Dashboard{% endblock %}

{% block head_extra %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-1 finance-dashboard">
<!-- Header -->
<div class="d-flex align-items-start justify-content-between mb-3 gap-2">
    <div>
    <h5 class="mb-0">üí∞ Finance Dashboard</h5>
    <div class="small text-muted">Manage payments, fees, and financial records</div>
    </div>

    <div class="d-flex gap-2 align-items-center">
    <div class="btn-group btn-group-sm" role="group">
        <button class="btn btn-outline-primary active" data-view="overview">Overview</button>
        <button class="btn btn-outline-primary" data-view="payments">Payments</button>
        <button class="btn btn-outline-primary" data-view="fees">Fee Structures</button>
        <button class="btn btn-outline-primary" data-view="balances">Balances</button>
    </div>
    
    <button id="exportFinanceBtn" class="btn btn-sm btn-outline-secondary" title="Export visible table to CSV">
        <i class="fas fa-file-csv"></i> Export
    </button>

    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="compactToggle">
        <label class="form-check-label small" for="compactToggle">Compact</label>
    </div>
    </div>
</div>

<!-- Overview Cards -->
<div id="overviewView" class="view-section">
    <div class="row g-3 mb-4">
    <!-- Total Revenue -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Total Revenue</h6>
                <h3 class="mb-0">GHS {{ total_revenue|default(0)|floatformat(2) }}</h3>
            </div>
            <i class="fas fa-coins text-success fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">All payments received</small>
        </div>
        </div>
    </div>

    <!-- Outstanding Balance -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Outstanding Balance</h6>
                <h3 class="mb-0 text-danger">GHS {{ outstanding_balance|default(0)|floatformat(2) }}</h3>
            </div>
            <i class="fas fa-exclamation-circle text-danger fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Unpaid fees</small>
        </div>
        </div>
    </div>

    <!-- Pending Payments -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Pending Approval</h6>
                <h3 class="mb-0 text-warning">{{ pending_count|default(0) }}</h3>
            </div>
            <i class="fas fa-hourglass-half text-warning fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Awaiting review</small>
        </div>
        </div>
    </div>

    <!-- Students with Debt -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Accounts in Arrears</h6>
                <h3 class="mb-0 text-info">{{ students_with_debt|default(0) }}</h3>
            </div>
            <i class="fas fa-user-slash text-info fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Students with debt</small>
        </div>
        </div>
    </div>
    </div>

    <!-- New Row: Additional Metrics -->
    <div class="row g-3 mb-4">
    <!-- Approved Payments -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Approved Payments</h6>
                <h3 class="mb-0 text-success">{{ approved_count|default(0) }}</h3>
            </div>
            <i class="fas fa-check-circle text-success fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Processed transactions</small>
        </div>
        </div>
    </div>

    <!-- Total Students -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Total Students</h6>
                <h3 class="mb-0 text-primary">{{ total_students|default(0) }}</h3>
            </div>
            <i class="fas fa-users text-primary fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">With fee records</small>
        </div>
        </div>
    </div>

    <!-- Collection Rate -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Collection Rate</h6>
                <h3 class="mb-0 text-primary">{{ collection_rate|default(0)|floatformat(1) }}%</h3>
            </div>
            <i class="fas fa-chart-pie text-primary fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Revenue vs Outstanding</small>
        </div>
        </div>
    </div>

    <!-- Fee Groups -->
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="text-muted mb-2 small">Fee Groups</h6>
                <h3 class="mb-0 text-secondary">{{ fee_groups_count|default(0) }}</h3>
            </div>
            <i class="fas fa-layer-group text-secondary fa-2x"></i>
            </div>
            <small class="text-muted d-block mt-2">Active fee structures</small>
        </div>
        </div>
    </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
        <div class="card-body">
            <h6 class="mb-3">‚ö° Quick Actions</h6>
            <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('finance.assign_fees') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Assign Fees
            </a>
            <a href="{{ url_for('finance.review_payments') }}" class="btn btn-sm btn-warning">
                <i class="fas fa-list-check me-1"></i> Review Payments ({{ pending_count|default(0) }})
            </a>
            <a href="{{ url_for('finance.view_balances') }}" class="btn btn-sm btn-info">
                <i class="fas fa-wallet me-1"></i> View Balances
            </a>
            <a href="{{ url_for('finance.view_fee_structures') }}" class="btn btn-sm btn-secondary">
                <i class="fas fa-file-invoice-dollar me-1"></i> Fee Structures
            </a>
            <a href="{{ url_for('finance.reports') }}" class="btn btn-sm btn-success">
                <i class="fas fa-chart-bar me-1"></i> Financial Reports
            </a>
            </div>
        </div>
        </div>
    </div>
    </div>
</div>

<!-- Payments Table View -->
<div id="paymentsView" class="view-section d-none">
    <div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Recent Payments</h6>
        <div class="d-flex gap-2 align-items-center">
            <input type="search" class="form-control form-control-sm search-input" placeholder="üîç Search payments..." style="min-width: 220px;">
            <select class="form-select form-select-sm rows-per-page" aria-label="Rows per page">
            <option value="10">10 / page</option>
            <option value="25" selected>25 / page</option>
            <option value="50">50 / page</option>
            </select>
        </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
        {% if payments %}
            <table class="table table-hover table-sm mb-0 finance-table" data-model="payments">
            <thead class="table-light small sticky-top">
                <tr>
                <th class="sortable" data-key="0">Student ID</th>
                <th class="sortable" data-key="1">Student Name</th>
                <th class="sortable" data-key="2">Amount</th>
                <th class="sortable" data-key="3">Date</th>
                <th class="sortable" data-key="4">Status</th>
                <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr data-json='{{ payment|tojson|safe }}'>
                    <td class="text-nowrap">{{ payment.student_id }}</td>
                    <td>{{ payment.student_name }}</td>
                    <td class="fw-semibold text-success">GHS {{ payment.amount|floatformat(2) }}</td>
                    <td class="text-nowrap small">{{ payment.date }}</td>
                    <td>
                    <span class="badge {% if payment.status == 'approved' %}bg-success{% elif payment.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ payment.status|upper }}
                    </span>
                    </td>
                    <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info view-btn" title="View">üëÅÔ∏è</button>
                        {% if payment.status == 'pending' %}
                        <button class="btn btn-outline-success approve-btn" title="Approve">‚úì</button>
                        <button class="btn btn-outline-danger reject-btn" title="Reject">‚úï</button>
                        {% endif %}
                    </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-2 small p-3 border-top">
            <div>
                <span class="text-muted pages-info">Showing <span class="start">1</span>-<span class="end">25</span> of <strong class="total">{{ payments|length }}</strong></span>
            </div>
            <nav aria-label="Table pages">
                <ul class="pagination pagination-sm mb-0">
                <li class="page-item prev-page disabled"><button class="page-link" aria-label="Previous">&laquo;</button></li>
                <li class="page-item next-page"><button class="page-link" aria-label="Next">&raquo;</button></li>
                </ul>
            </nav>
            </div>
        {% else %}
            <p class="text-muted text-center p-4 mb-0">No payments found.</p>
        {% endif %}
        </div>
    </div>
    </div>
</div>

<!-- Fee Structures View -->
<div id="feesView" class="view-section" style="display:none;">
    <div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Fee Structures</h6>
        <div class="d-flex gap-2 align-items-center">
            <input type="search" class="form-control form-control-sm search-input" placeholder="üîç Search fees..." style="min-width: 220px;">
            <button class="btn btn-sm btn-success">+ New Fee Structure</button>
        </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
        {% if fee_structures %}
            <table class="table table-hover table-sm mb-0 finance-table" data-model="fee_structures">
            <thead class="table-light small sticky-top">
                <tr>
                <th class="sortable">Programme</th>
                <th class="sortable">Level</th>
                <th class="sortable">Total Amount</th>
                <th class="sortable">Items</th>
                <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for fee in fee_structures %}
                <tr data-json='{{ fee|tojson|safe }}'>
                    <td>{{ fee.programme_name }}</td>
                    <td class="text-center">{{ fee.level }}</td>
                    <td class="fw-semibold">GHS {{ fee.total_amount|floatformat(2) }}</td>
                    <td class="text-center"><span class="badge bg-secondary">{{ fee.item_count }}</span></td>
                    <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info view-btn" title="View">üëÅÔ∏è</button>
                        <button class="btn btn-outline-primary edit-btn" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-outline-danger delete-btn" title="Delete">üóëÔ∏è</button>
                    </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        {% else %}
            <p class="text-muted text-center p-4 mb-0">No fee structures found.</p>
        {% endif %}
        </div>
    </div>
    </div>
</div>

<!-- Student Balances View -->
<div id="balancesView" class="view-section" style="display:none;">
    <div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Student Fee Balances</h6>
        <div class="d-flex gap-2 align-items-center">
            <input type="search" class="form-control form-control-sm search-input" placeholder="üîç Search balances..." style="min-width: 220px;">
            <select class="form-select form-select-sm" aria-label="Filter by status">
            <option value="">All Balances</option>
            <option value="pending">Pending Only</option>
            <option value="partial">Partial Payments</option>
            <option value="paid">Paid</option>
            </select>
        </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
        {% if balances %}
            <table class="table table-hover table-sm mb-0 finance-table" data-model="balances">
            <thead class="table-light small sticky-top">
                <tr>
                <th class="sortable">Student</th>
                <th class="sortable">Programme</th>
                <th class="sortable">Amount Due</th>
                <th class="sortable">Amount Paid</th>
                <th class="sortable">Balance</th>
                <th class="sortable">Status</th>
                <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for balance in balances %}
                <tr data-json='{{ balance|tojson|safe }}'>
                    <td>{{ balance.student_name }}</td>
                    <td>{{ balance.programme }}</td>
                    <td class="text-nowrap">GHS {{ balance.amount_due|floatformat(2) }}</td>
                    <td class="text-nowrap text-success fw-semibold">GHS {{ balance.amount_paid|floatformat(2) }}</td>
                    <td class="text-nowrap {% if balance.balance > 0 %}text-danger{% else %}text-success{% endif %} fw-semibold">
                    GHS {{ balance.balance|floatformat(2) }}
                    </td>
                    <td>
                    <span class="badge {% if balance.status == 'paid' %}bg-success{% elif balance.status == 'pending' %}bg-danger{% else %}bg-warning{% endif %}">
                        {{ balance.status|upper }}
                    </span>
                    </td>
                    <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-info view-btn" title="View">üëÅÔ∏è</button>
                        <button class="btn btn-outline-primary record-payment-btn" title="Record Payment">üíµ</button>
                    </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        {% else %}
            <p class="text-muted text-center p-4 mb-0">No balances found.</p>
        {% endif %}
        </div>
    </div>
    </div>
</div>

</div>

<!-- View/Edit Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
<div class="modal-dialog modal-lg">
    <div class="modal-content">
    <div class="modal-header">
        <h6 class="modal-title">Record Details</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <form id="recordForm" class="row"></form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveBtn">Save Changes</button>
    </div>
    </div>
</div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
<div class="modal-dialog">
    <div class="modal-content">
    <div class="modal-header">
        <h6 class="modal-title">Record Payment</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <form id="paymentForm">
        <div class="mb-3">
            <label class="form-label">Student</label>
            <input type="text" class="form-control" id="paymentStudent" readonly>
        </div>
        <div class="mb-3">
            <label class="form-label">Outstanding Balance</label>
            <div class="input-group">
            <span class="input-group-text">GHS</span>
            <input type="text" class="form-control" id="paymentBalance" readonly>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Amount to Pay *</label>
            <div class="input-group">
            <span class="input-group-text">GHS</span>
            <input type="number" class="form-control" id="paymentAmount" min="0" step="0.01" placeholder="0.00" required>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Payment Method</label>
            <select class="form-select" id="paymentMethod">
            <option value="">-- Select --</option>
            <option value="cash">Cash</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="mobile_money">Mobile Money</option>
            <option value="cheque">Cheque</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Reference/Transaction ID</label>
            <input type="text" class="form-control" id="paymentReference" placeholder="e.g., TXN123456">
        </div>
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Optional notes..."></textarea>
        </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="submitPaymentBtn">Record Payment</button>
    </div>
    </div>
</div>
</div>

<style>
/* Finance Dashboard Styling */
.finance-dashboard { font-size: 0.9rem; }
.finance-dashboard h5 { font-size: 1.1rem; font-weight: 600; }
.finance-dashboard .card { border: 1px solid #e9ecef; }
.finance-dashboard .card-header { border-bottom: 1px solid #e9ecef; padding: 0.75rem 1rem; }
.finance-dashboard .finance-table { font-size: 0.85rem; margin-bottom: 0; }
.finance-dashboard .finance-table th, .finance-table td { padding: 0.4rem 0.6rem; vertical-align: middle; }
.finance-dashboard .finance-table tbody tr:hover { background: #f8f9fa; cursor: pointer; }

/* View Sections */
.view-section { animation: fadeIn 0.2s ease-in; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Buttons */
.btn-group-sm .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; }

/* Cards */
.finance-dashboard .card-body { padding: 1.25rem; }
.finance-dashboard .card-body h3 { font-size: 1.8rem; font-weight: 700; }
.finance-dashboard .card-body h6 { font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; }
.finance-dashboard .card-body .small { font-size: 0.8rem; }

/* Status Badges */
.badge { font-size: 0.75rem; padding: 0.4rem 0.6rem; }

/* Compact Mode */
body.compact-mode .finance-dashboard { font-size: 0.85rem; }
body.compact-mode .finance-dashboard .finance-table th, 
body.compact-mode .finance-dashboard .finance-table td { padding: 0.3rem 0.5rem; }
</style>

<script>
// ‚úÖ FIXED: Declare modals at top level but don't initialize yet
let recordModal;
let paymentModal;

// Utility helpers
function debounce(fn, wait=250){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }
function csvEscape(val){ if (val == null) return ''; return '"' + String(val).replace(/"/g, '""') + '"'; }

const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

// Build modal form fields
function buildForm(data, editable=false) {
  const form = document.getElementById('recordForm');
  form.innerHTML = '';
  const readonlyFields = ['id', 'created_at', 'updated_at', 'approved_at', 'rejected_at'];

  Object.entries(data).forEach(([k, v]) => {
    const name = k.toLowerCase();
    const isReadonly = readonlyFields.includes(name);
    let inputHtml = '';

    if (typeof v === 'boolean') {
      inputHtml = `<div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="${k}" ${v ? 'checked' : ''} ${editable && !isReadonly ? '' : 'disabled'}></div>`;
    } else if (String(v).length > 100) {
      inputHtml = `<textarea class="form-control" name="${k}" rows="3" ${editable && !isReadonly ? '' : 'readonly'}>${v ?? ''}</textarea>`;
    } else {
      inputHtml = `<input class="form-control" type="text" name="${k}" value="${v ?? ''}" ${editable && !isReadonly ? '' : 'readonly'}>`;
    }

    form.insertAdjacentHTML('beforeend', `<div class="col-md-6 mb-3"><label class="form-label small text-muted">${k}</label>${inputHtml}</div>`);
  });
}

// Export table to CSV
function exportTableToCSV(table, filename) {
  const cols = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => th.innerText.trim());
  const rows = Array.from(table.tBodies[0].rows).filter(r => r.style.display !== 'none');
  const csv = [cols.map(csvEscape).join(',')].concat(rows.map(r => {
    const cells = Array.from(r.cells).slice(0, -1).map(td => csvEscape(td.innerText.trim()));
    return cells.join(',');
  }));
  const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename || 'finance-export.csv';
  document.body.appendChild(link);
  link.click();
  link.remove();
}

// Pagination
function applyPagination(container) {
  const table = container.querySelector('table');
  if (!table) return;
  const rows = Array.from(table.tBodies[0].rows);
  const perPageSelect = container.querySelector('.rows-per-page');
  const prevBtn = container.querySelector('.prev-page');
  const nextBtn = container.querySelector('.next-page');
  const startSpan = container.querySelector('.start');
  const endSpan = container.querySelector('.end');
  const totalSpan = container.querySelector('.total');

  let perPage = Number(perPageSelect?.value || 25);
  let page = 1;
  const total = rows.length;
  if (totalSpan) totalSpan.innerText = total;

  function render() {
    const start = (page - 1) * perPage;
    const end = Math.min(start + perPage, total);
    rows.forEach((r, i) => r.style.display = (i >= start && i < end) ? '' : 'none');
    if (startSpan) startSpan.innerText = total === 0 ? 0 : start + 1;
    if (endSpan) endSpan.innerText = end;
    if (prevBtn) prevBtn.classList.toggle('disabled', page === 1);
    if (nextBtn) nextBtn.classList.toggle('disabled', page * perPage >= total);
  }

  perPageSelect?.addEventListener('change', () => { perPage = Number(perPageSelect.value); page = 1; render(); });
  prevBtn?.addEventListener('click', (e) => { e.preventDefault(); if (page > 1) { page--; render(); }});
  nextBtn?.addEventListener('click', (e) => { e.preventDefault(); if (page * perPage < total) { page++; render(); }});

  render();
}

// ‚úÖ FIXED: Initialize in DOMContentLoaded when Bootstrap is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Now that Bootstrap is loaded, initialize modals
  recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
  paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

  const viewBtns = document.querySelectorAll('[data-view]');
  const viewSections = document.querySelectorAll('.view-section');
  const compactToggle = document.getElementById('compactToggle');
  const exportBtn = document.getElementById('exportFinanceBtn');

  // View switching
  viewBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;

      // Activate button
      viewBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Show correct section
      viewSections.forEach(sec => sec.classList.add('d-none'));
      const activeSection = document.getElementById(view + 'View');
      activeSection.classList.remove('d-none');

      // Re-apply pagination
      applyPagination(activeSection);
    });
  });

  // Compact mode
  if (localStorage.getItem('compactMode') === '1') {
    document.body.classList.add('compact-mode');
    compactToggle.checked = true;
  }
  compactToggle.addEventListener('change', () => {
    document.body.classList.toggle('compact-mode', compactToggle.checked);
    localStorage.setItem('compactMode', compactToggle.checked ? '1' : '0');
  });

  // Export
  exportBtn.addEventListener('click', () => {
    const visibleSection = document.querySelector('.view-section:not(.d-none)');
    const table = visibleSection?.querySelector('table');
    if (!table) return alert('No data to export.');
    exportTableToCSV(table, `finance-${new Date().toISOString().slice(0,10)}.csv`);
  });

  // Initialize pagination for first view
  applyPagination(document.querySelector('.view-section:not(.d-none)'));

  // Row actions for each table
  document.querySelectorAll('.finance-table tbody tr').forEach(tr => {
    tr.querySelector('.view-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const data = JSON.parse(tr.dataset.json);
      buildForm(data, false);
      recordModal.show();
    });

    tr.querySelector('.approve-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const data = JSON.parse(tr.dataset.json);
      if (!confirm(`Approve this payment?`)) return;
      fetch(`/admin/finance/approve/${data.id}`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken}
      }).then(r => {
        if (r.ok) { alert('Payment approved!'); location.reload(); }
        else alert('Failed to approve payment');
      }).catch(() => alert('Network error'));
    });

    tr.querySelector('.reject-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const data = JSON.parse(tr.dataset.json);
      if (!confirm(`Reject this payment?`)) return;
      fetch(`/admin/finance/reject/${data.id}`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken}
      }).then(r => {
        if (r.ok) { alert('Payment rejected!'); location.reload(); }
        else alert('Failed to reject payment');
      }).catch(() => alert('Network error'));
    });

    tr.querySelector('.record-payment-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const data = JSON.parse(tr.dataset.json);
      document.getElementById('paymentStudent').value = data.student_name;
      document.getElementById('paymentBalance').value = data.balance;
      paymentModal.show();
    });
  });

  // Search in tables
  document.querySelectorAll('.view-section').forEach(section => {
    const searchInput = section.querySelector('.search-input');
    const table = section.querySelector('table');
    if (!searchInput || !table) return;
    
    const rows = Array.from(table.tBodies[0].rows);
    searchInput.addEventListener('input', debounce(() => {
      const q = searchInput.value.toLowerCase();
      rows.forEach(r => {
        const match = q === '' || r.innerText.toLowerCase().includes(q);
        r.style.display = match ? '' : 'none';
      });
    }, 250));
  });

  // Submit payment
  document.getElementById('submitPaymentBtn')?.addEventListener('click', () => {
    const amount = document.getElementById('paymentAmount').value;
    const method = document.getElementById('paymentMethod').value;
    const reference = document.getElementById('paymentReference').value;
    const notes = document.getElementById('paymentNotes').value;

    if (!amount || !method) return alert('Please fill required fields');

    fetch('/admin/finance/record-payment', {
      method: 'POST',
      headers: {'X-CSRFToken': csrfToken, 'Content-Type': 'application/json'},
      body: JSON.stringify({amount, method, reference, notes})
    }).then(r => {
      if (r.ok) { alert('Payment recorded!'); paymentModal.hide(); location.reload(); }
      else alert('Failed to record payment');
    }).catch(() => alert('Network error'));
  });
});
</script>
{% endblock %}
