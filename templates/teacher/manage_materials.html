{% extends 'teacher/base_teacher.html' %}
{% block title %}Manage Course Materials{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
    <div>
      <h4 class="mb-1"><i class="fas fa-book-open text-primary me-2"></i> Manage Course Materials</h4>
      <small class="text-muted">Organize and share PDFs, videos and documents with your students.</small>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <a href="{{ url_for('teacher.add_material') }}" class="btn btn-success">
        <i class="fas fa-plus me-1"></i> Add Material
      </a>
      <button id="clearFilters" class="btn btn-outline-secondary" title="Clear filters">
        <i class="fas fa-eraser"></i>
      </button>
    </div>
  </div>

  <!-- Alerts -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show small" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Stats (compact cards) -->
  <div class="row g-2 mb-3">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body p-2 text-center">
          <div class="text-muted small">Total Materials</div>
          <div class="h5 mb-0 fw-bold">{{ materials|length }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body p-2 text-center">
          <div class="text-muted small">PDFs</div>
          <div class="h5 mb-0 fw-bold text-danger">{{ materials|selectattr("file_type","equalto","pdf")|list|length }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body p-2 text-center">
          <div class="text-muted small">Videos</div>
          <div class="h5 mb-0 fw-bold text-primary">{{ materials|selectattr("file_type","in",["mp4","avi","mov"])|list|length }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body p-2 text-center">
          <div class="text-muted small">Docs</div>
          <div class="h5 mb-0 fw-bold text-info">{{ materials|selectattr("file_type","in",["docx","pptx","xls","xlsx"])|list|length }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body py-3">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-5">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
            <input id="materialSearch" type="search" class="form-control" placeholder="Search title, course, programme, level...">
          </div>
        </div>

        <div class="col-6 col-md-2">
          <select id="filterProgramme" class="form-select">
            <option value="">All Programmes</option>
            {% set programmes = materials|map(attribute='programme_name')|unique|list %}
            {% for p in programmes %}
              {% if p %}<option value="{{ p }}">{{ p }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-1">
          <select id="filterLevel" class="form-select">
            <option value="">All Levels</option>
            {% set levels = materials|map(attribute='programme_level')|unique|list %}
            {% for lv in levels %}
              {% if lv %}<option value="{{ lv }}">L{{ lv }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-2">
          <select id="filterCourse" class="form-select">
            <option value="">All Courses</option>
            {% set courses = materials|map(attribute='course_name')|unique|list %}
            {% for c in courses %}
              {% if c %}<option value="{{ c }}">{{ c }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-1">
          <select id="filterType" class="form-select">
            <option value="">Type</option>
            <option value="pdf">PDF</option>
            <option value="video">Video</option>
            <option value="document">Doc</option>
          </select>
        </div>

      </div>
    </div>
  </div>

  <!-- Results area -->
  <div id="resultsArea">

    <!-- Grid for small screens -->
    <div class="row g-3 d-lg-none" id="cardGrid">
      {% for m in materials %}
        <div class="col-12 material-card-wrap" 
             data-type="{{ m.file_type }}" 
             data-course="{{ m.course_name or '' }}" 
             data-programme="{{ m.programme_name or '' }}" 
             data-level="{{ m.programme_level or '' }}" 
             data-title="{{ m.title or '' }}">
          <div class="card shadow-sm h-100 material-card">
            <div class="card-body d-flex gap-2">
              <div class="flex-shrink-0 align-self-start">
                {% set ft = m.file_type %}
                <div class="icon-box rounded-3 text-center" style="width:56px;height:56px;display:flex;align-items:center;justify-content:center;background:#f5f7fa;">
                  {% if ft == 'pdf' %}
                    <i class="fas fa-file-pdf fa-2x text-danger"></i>
                  {% elif ft in ['mp4','mov','avi'] %}
                    <i class="fas fa-video fa-2x text-primary"></i>
                  {% else %}
                    <i class="fas fa-file-alt fa-2x text-muted"></i>
                  {% endif %}
                </div>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{{ m.title }}</div>
                    <div class="text-muted small">{{ m.course_name or '—' }} • {{ m.programme_name or '—' }} • L{{ m.programme_level or '—' }}</div>
                  </div>
                  <div class="text-end ms-2">
                    <div class="small text-muted">{{ (m.file_type or '').upper() }}</div>
                    <div class="mt-2">
                      <a href="{{ url_for('teacher.download_material', filename=m.filename) }}" class="btn btn-sm btn-outline-secondary me-1" target="_blank">Open</a>
                      <button class="btn btn-sm btn-outline-danger delete-btn-sm" data-url="{{ url_for('teacher.delete_material', material_id=m.id) }}" title="Delete">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Table for larger screens -->
    <div class="table-responsive d-none d-lg-block" id="tableView">
      <table class="table table-hover align-middle" id="materialTable">
        <thead class="table-secondary">
          <tr>
            <th style="width:42px;"></th>
            <th>Title</th>
            <th>Course</th>
            <th>Programme</th>
            <th>Level</th>
            <th>Type</th>
            <th style="width:160px" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for m in materials %}
          <tr class="material-row"
              data-type="{{ m.file_type }}"
              data-course="{{ m.course_name or '' }}"
              data-programme="{{ m.programme_name or '' }}"
              data-level="{{ m.programme_level or '' }}"
              data-title="{{ m.title or '' }}">
            <td>
              {% set ft = m.file_type %}
              {% if ft == 'pdf' %}
                <i class="fas fa-file-pdf text-danger"></i>
              {% elif ft in ['mp4','mov','avi'] %}
                <i class="fas fa-video text-primary"></i>
              {% else %}
                <i class="fas fa-file-alt text-muted"></i>
              {% endif %}
            </td>
            <td class="fw-semibold">{{ m.title }}</td>
            <td>{{ m.course_name or '—' }}</td>
            <td>{{ m.programme_name or '—' }}</td>
            <td>
              {% if m.programme_level %}
                <span class="badge bg-light text-dark">L{{ m.programme_level }}</span>
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <span class="badge 
                {% if ft == 'pdf' %} bg-danger
                {% elif ft in ['mp4','mov','avi'] %} bg-primary
                {% elif ft in ['docx','pptx','xls','xlsx'] %} bg-info text-dark
                {% else %} bg-secondary
                {% endif %}">
                {{ (ft or '')|upper }}
              </span>
            </td>
            <td class="text-end">
              <a href="{{ url_for('teacher.download_material', filename=m.filename) }}" class="btn btn-sm btn-outline-secondary me-1" target="_blank">Open</a>
              <a href="{{ url_for('teacher.edit_material', material_id=m.id) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-url="{{ url_for('teacher.delete_material', material_id=m.id) }}">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Styles -->
<style>
  .material-card { transition: transform .12s ease, box-shadow .12s ease, opacity .25s ease; }
  .material-card-wrap.removing, .material-row.removing { opacity: .3; transform: scale(.98); }
  .icon-box { border-radius: 8px; }
  .card .btn { font-size: .85rem; }
  @media (max-width: 991px) {
    #tableView { display:none !important; }
  }
  @media (min-width: 992px) {
    #cardGrid { display:none !important; }
  }
</style>

<!-- Behavior -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('materialSearch');
  const filterProgramme = document.getElementById('filterProgramme');
  const filterLevel = document.getElementById('filterLevel');
  const filterCourse = document.getElementById('filterCourse');
  const filterType = document.getElementById('filterType');
  const clearBtn = document.getElementById('clearFilters');

  function normalize(v){ return (v||'').toString().trim().toLowerCase(); }

  function applyFilters() {
    const q = normalize(searchInput?.value);
    const programme = normalize(filterProgramme?.value);
    const level = normalize(filterLevel?.value);
    const course = normalize(filterCourse?.value);
    const type = normalize(filterType?.value);

    // All material-card-wrap (mobile) and material-row (desktop)
    const cards = Array.from(document.querySelectorAll('.material-card-wrap, .material-row'));
    cards.forEach(el => {
      const title = normalize(el.dataset.title);
      const programmeName = normalize(el.dataset.programme);
      const levelVal = normalize(el.dataset.level);
      const courseName = normalize(el.dataset.course);
      const fileType = normalize(el.dataset.type);

      const matchesText = !q || title.includes(q) || programmeName.includes(q) || courseName.includes(q) || levelVal.includes(q);
      const matchesProgramme = !programme || programmeName === programme;
      const matchesLevel = !level || levelVal === level;
      const matchesCourse = !course || courseName === course;
      const matchesType = !type || (
          type === 'pdf' && fileType === 'pdf' ||
          type === 'video' && ['mp4','avi','mov'].includes(fileType) ||
          type === 'document' && ['docx','pptx','xls','xlsx'].includes(fileType) ||
          type === fileType
      );

      const show = matchesText && matchesProgramme && matchesLevel && matchesCourse && matchesType;
      el.style.display = show ? '' : 'none';
    });
  }

  [searchInput, filterProgramme, filterLevel, filterCourse, filterType].forEach(el => {
    if (!el) return;
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });

  clearBtn?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    if (filterProgramme) filterProgramme.selectedIndex = 0;
    if (filterLevel) filterLevel.selectedIndex = 0;
    if (filterCourse) filterCourse.selectedIndex = 0;
    if (filterType) filterType.selectedIndex = 0;
    applyFilters();
  });

  // Delete handlers (vanilla fetch, animate)
  async function handleDelete(url, element) {
    if (!confirm('Are you sure you want to delete this material?')) return;
    const token = (document.querySelector('meta[name="csrf-token"]') || document.querySelector('input[name="csrf_token"]'))?.content
                || (document.querySelector('input[name="csrf_token"]')?.value) || '';
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        alert('Delete failed: ' + txt);
        return;
      }
      // animate removal
      element.classList.add('removing');
      setTimeout(() => {
        element.remove();
      }, 260);
    } catch (err) {
      console.error('Delete error', err);
      alert('Network error while deleting material.');
    }
  }

  document.querySelectorAll('.delete-btn, .delete-btn-sm').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const url = btn.dataset.url;
      // choose row or card parent
      const row = btn.closest('tr') || btn.closest('.material-card-wrap');
      handleDelete(url, row);
    });
  });

  // initial filter pass
  applyFilters();
});
</script>
{% endblock %}
