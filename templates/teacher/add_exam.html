{% extends 'teacher/base_teacher.html' %}
{% block title %}Add Exam | Teacher Panel{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-lg border-0">
    <!-- Gradient Header -->
    <div class="card-header text-white" style="background: linear-gradient(90deg, #4e73df, #1cc88a);">
      <h3 class="mb-0"><i class="fas fa-clipboard-list"></i> Create New Exam</h3>
    </div>

    <div class="card-body">
      <form method="POST" novalidate>
        {{ form.hidden_tag() }}

        <!-- Title -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-heading text-primary"></i> {{ form.title.label }}</label>
          {{ form.title(class="form-control", placeholder="Enter exam title") }}
          {% if form.title.errors %}
            <small class="text-danger">{{ form.title.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Programme, Level, Course -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-graduation-cap text-warning"></i> {{ form.programme_name.label }}</label>
            {{ form.programme_name(class="form-select") }}
            {% if form.programme_name.errors %}
              <small class="text-danger">{{ form.programme_name.errors[0] }}</small>
            {% endif %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-layer-group text-info"></i> {{ form.programme_level.label }}</label>
            {{ form.programme_level(class="form-select") }}
            {% if form.programme_level.errors %}
              <small class="text-danger">{{ form.programme_level.errors[0] }}</small>
            {% endif %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-book text-success"></i> {{ form.course_id.label }}</label>
            {{ form.course_id(class="form-select") }}
            {% if form.course_id.errors %}
              <small class="text-danger">{{ form.course_id.errors[0] }}</small>
            {% endif %}
          </div>
        </div>

        <!-- DateTime -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-clock text-success"></i> {{ form.start_datetime.label }}</label>
            {{ form.start_datetime(class="form-control", type="datetime-local") }}
            {% if form.start_datetime.errors %}
              <small class="text-danger">{{ form.start_datetime.errors[0] }}</small>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-hourglass-end text-danger"></i> {{ form.end_datetime.label }}</label>
            {{ form.end_datetime(class="form-control", type="datetime-local") }}
            {% if form.end_datetime.errors %}
              <small class="text-danger">{{ form.end_datetime.errors[0] }}</small>
            {% endif %}
          </div>
        </div>

        <!-- Duration -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-stopwatch text-primary"></i> {{ form.duration_minutes.label }}</label>
          {{ form.duration_minutes(class="form-control", placeholder="e.g., 90") }}
          <div id="durationPreview" class="form-text mt-1"></div>
          {% if form.duration_minutes.errors %}
            <small class="text-danger">{{ form.duration_minutes.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Assignment Mode -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-random text-dark"></i> {{ form.assignment_mode.label }}</label>
          {{ form.assignment_mode(class="form-select", id="assignment_mode") }}
          <div class="form-text small mt-1">
            <span class="badge bg-secondary">Random</span> Each student gets a random set.<br>
            <span class="badge bg-info">Hash</span> Deterministic set assignment based on student ID.<br>
            <span class="badge bg-warning text-dark">Choice</span> Students choose their set manually.
          </div>
          {% if form.assignment_mode.errors %}
            <small class="text-danger">{{ form.assignment_mode.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Assignment Seed -->
        <div class="mb-3 collapse" id="assignment-seed-group">
          <label class="form-label fw-bold"><i class="fas fa-key text-success"></i> {{ form.assignment_seed.label }}</label>
          {{ form.assignment_seed(class="form-control", placeholder="Optional seed value") }}
          <div class="form-text small">Used only in <strong>Hash</strong> mode to make assignments reproducible.</div>
          {% if form.assignment_seed.errors %}
            <small class="text-danger">{{ form.assignment_seed.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Create Exam
          </button>
          <a href="{{ url_for('teacher.manage_exams') }}" class="btn btn-outline-secondary">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const programmeSelect = document.getElementById("programme_name");
  const levelSelect = document.getElementById("programme_level");
  const courseSelect = document.getElementById("course_id");
  const modeSelect = document.getElementById("assignment_mode");
  const seedGroup = document.getElementById("assignment-seed-group");
  const durationInput = document.querySelector("[name='duration_minutes']");
  const durationPreview = document.getElementById("durationPreview");

  // Toggle seed field visibility based on mode
  function toggleSeedField() {
    if (modeSelect.value === "hash") {
      new bootstrap.Collapse(seedGroup, { show: true });
    } else {
      new bootstrap.Collapse(seedGroup, { hide: true });
    }
  }

  // Live duration preview
  function updateDurationPreview() {
    const mins = parseInt(durationInput.value) || 0;
    if (mins <= 0) {
      durationPreview.innerHTML = "";
      return;
    }
    const hours = Math.floor(mins / 60);
    const remaining = mins % 60;
    let text = "";
    if (hours > 0) text += `${hours}h `;
    if (remaining > 0) text += `${remaining}m`;
    durationPreview.innerHTML = `<span class="badge bg-success">⏱ ${text.trim()}</span>`;
  }

  // Load courses when programme/level changes
  function loadCourses() {
    const programme = programmeSelect.value;
    const level = levelSelect.value;

    if (!programme || !level) {
      courseSelect.innerHTML = '<option value="">Select programme and level first</option>';
      courseSelect.disabled = true;
      return;
    }

    courseSelect.disabled = true;
    courseSelect.innerHTML = '<option value="">Loading courses...</option>';

    fetch(`/teacher/get_courses/${encodeURIComponent(programme)}/${encodeURIComponent(level)}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load courses');
        return res.json();
      })
      .then(data => {
        courseSelect.innerHTML = '<option value="">— Select Course —</option>';
        
        if (!data || data.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No courses available';
          courseSelect.appendChild(opt);
          courseSelect.disabled = true;
          return;
        }

        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = `${c.code} — ${c.name}`;
          courseSelect.appendChild(opt);
        });
        courseSelect.disabled = false;
      })
      .catch(err => {
        console.error('Error loading courses:', err);
        courseSelect.innerHTML = '<option value="">Error loading courses</option>';
        courseSelect.disabled = true;
      });
  }

  // Event listeners
  if (modeSelect) modeSelect.addEventListener("change", toggleSeedField);
  if (durationInput) durationInput.addEventListener("input", updateDurationPreview);
  if (programmeSelect) programmeSelect.addEventListener("change", loadCourses);
  if (levelSelect) levelSelect.addEventListener("change", loadCourses);

  // Initialize
  toggleSeedField();
  updateDurationPreview();
});
</script>

{% endblock %}