{% extends 'teacher/base_teacher.html' %}
{% block title %}Edit Assignment{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm border-0">
    <div class="card-header text-white rounded-top-3" style="background: linear-gradient(90deg,#2b2d42,#3a3d63);">
      <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Edit Assignment</h5>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" novalidate>
        {{ form.hidden_tag() }}

        <input type="hidden" id="course_id" name="course_id" value="{{ form.course_id.data or assignment.course_id or '' }}">

        <!-- Title -->
        <div class="mb-3">
          {{ form.title.label(class="form-label fw-semibold") }}
          {{ form.title(class="form-control", placeholder="Enter assignment title") }}
          {% if form.title.errors %}
            <small class="text-danger">{{ form.title.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Programme -->
        <div class="row">
          <div class="col-md-4 mb-3">
            {{ form.programme.label(class="form-label fw-semibold text-info") }}
            {{ form.programme(class="form-select") }}
            {% if form.programme.errors %}
              <small class="text-danger">{{ form.programme.errors[0] }}</small>
            {% endif %}
          </div>

          <!-- Programme Level -->
          <div class="col-md-4 mb-3">
            {{ form.programme_level.label(class="form-label fw-semibold text-info") }}
            {{ form.programme_level(class="form-select") }}
            {% if form.programme_level.errors %}
              <small class="text-danger">{{ form.programme_level.errors[0] }}</small>
            {% endif %}
          </div>

          <!-- Course -->
          <div class="col-md-4 mb-3">
            {{ form.course_name.label(class="form-label fw-semibold text-info") }}
            {{ form.course_name(class="form-select") }}
            {% if form.course_name.errors %}
              <small class="text-danger">{{ form.course_name.errors[0] }}</small>
            {% endif %}
          </div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          {{ form.description.label(class="form-label fw-semibold") }}
          {{ form.description(class="form-control", rows=4, placeholder="Brief overview of the assignment") }}
          {% if form.description.errors %}
            <small class="text-danger">{{ form.description.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Instructions -->
        <div class="mb-3">
          {{ form.instructions.label(class="form-label fw-semibold") }}
          {{ form.instructions(class="form-control", rows=4, placeholder="Detailed instructions for students") }}
          {% if form.instructions.errors %}
            <small class="text-danger">{{ form.instructions.errors[0] }}</small>
          {% endif %}
        </div>

        <!-- Due Date & Max Score -->
        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.due_date.label(class="form-label fw-semibold") }}
            {{ form.due_date(class="form-control", type="datetime-local") }}
            {% if form.due_date.errors %}
              <small class="text-danger">{{ form.due_date.errors[0] }}</small>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            {{ form.max_score.label(class="form-label fw-semibold") }}
            {{ form.max_score(class="form-control", type="number", step="0.5", min="0") }}
            {% if form.max_score.errors %}
              <small class="text-danger">{{ form.max_score.errors[0] }}</small>
            {% endif %}
          </div>
        </div>

        <!-- File Upload -->
        <div class="mb-3">
          {{ form.file.label(class="form-label fw-semibold") }}
          {{ form.file(class="form-control") }}
          {% if form.file.errors %}
            <small class="text-danger">{{ form.file.errors[0] }}</small>
          {% endif %}
          
          {% if assignment.filename %}
            <div class="mt-2 alert alert-info">
              <strong>Current file:</strong> 
              <a href="{{ url_for('static', filename='uploads/assignments/' ~ assignment.filename) }}" target="_blank" class="alert-link">
                {{ assignment.original_name }}
              </a>
              <br>
              <small>Upload a new file to replace the existing one.</small>
            </div>
          {% endif %}
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i> Update Assignment
          </button>
          <a href="{{ url_for('teacher.manage_assignments') }}" class="btn btn-secondary">
            <i class="fas fa-times me-2"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Populate form with existing assignment data
document.addEventListener('DOMContentLoaded', function() {
  const programme = document.getElementById('programme');
  const level = document.getElementById('programme_level');
  const courseSelect = document.getElementById('course_name');
  const courseIdInput = document.getElementById('course_id');

  // Set initial values from assignment
  if (programme) programme.value = "{{ assignment.programme_name }}";
  if (level) level.value = "{{ assignment.programme_level }}";
  if (courseIdInput) courseIdInput.value = "{{ assignment.course_id }}";

  // Update courses when programme or level changes
  async function updateCourses() {
    const programme = document.getElementById('programme')?.value || '';
    const lvl = document.getElementById('programme_level')?.value || '';

    if (!programme || !lvl) return;

    try {
      const url = `/teacher/courses_for_programme?programme=${encodeURIComponent(programme)}&level=${encodeURIComponent(lvl)}`;
      const res = await fetch(url);
      const courses = await res.json();

      courseSelect.innerHTML = '';
      
      if (!courses || courses.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No courses available';
        courseSelect.appendChild(opt);
        return;
      }

      courses.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.dataset.id = c.id;
        opt.textContent = `${c.code} â€“ ${c.name}`;
        if (c.id == "{{ assignment.course_id }}") {
          opt.selected = true;
        }
        courseSelect.appendChild(opt);
      });
    } catch (err) {
      console.error('Error fetching courses:', err);
    }
  }

  // Event listeners for dynamic updates
  if (programme) programme.addEventListener('change', updateCourses);
  if (level) level.addEventListener('change', updateCourses);

  // Sync course_id when course changes
  if (courseSelect) {
    courseSelect.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      if (courseIdInput) courseIdInput.value = selected?.dataset?.id || '';
    });
  }

  // Initial load of courses
  updateCourses();
});
</script>
{% endblock %}