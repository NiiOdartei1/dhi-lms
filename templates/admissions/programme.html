{% extends "admissions/base_admission.html" %}

{% block title %}Programme Choice | Admissions{% endblock %}

{% block extra_css %}
<style>
/* Small progress bar */
/* Small progress bar (fixed numbering + connectors) */
.progressbar {
  display: flex;
  gap: 0.5rem;
  list-style: none;
  padding: 0;
  margin: 0 0 1.25rem 0;
  counter-reset: step;                /* ← IMPORTANT: reset counter here */
  align-items: flex-start;
}

.progressbar li {
  flex: 1 1 0;
  text-align: center;
  position: relative;
  color: #6c757d;
  font-size: 0.9rem;
  padding-top: 6px;                   /* room for the badge */
}

/* round badge with number */
.progressbar li::before {
  content: counter(step);
  counter-increment: step;
  width: 30px;
  height: 30px;
  line-height: 30px;
  display: block;
  margin: 0 auto 0.5rem;
  border-radius: 50%;
  border: 2px solid #6c757d;
  background: #fff;
  color: #6c757d;
  text-align: center;
  font-weight: 600;
  box-sizing: border-box;
}

/* connector line (spans between items, won't shift earlier badges) */
.progressbar li::after {
  content: "";
  position: absolute;
  top: 20px;                            /* vertical center of the badge */
  left: 50%;
  right: -50%;
  height: 2px;
  background: #e9ecef;
  z-index: -1;
  transform: translateX(-50%);
}

/* remove connector on first item */
.progressbar li:first-child::after {
  content: none;
}

/* active state */
.progressbar li.active {
  color: #0d6efd;
  font-weight: 600;
}
.progressbar li.active::before {
  border-color: #0d6efd;
  background: #0d6efd;
  color: #fff;
}
.progressbar li.active::after {
  background: #0d6efd;
}

/* Helper and guide styling (kept as you had) */
.progress-helper {
  font-size: 0.875rem;
  color: #6c757d;
}

/* Helper card for programme groups */
.programme-guide {
  border-left: 3px solid #0d6efd;
  background: rgba(13,110,253,0.03);
  padding: 0.75rem 1rem;
  border-radius: 6px;
  font-size: .95rem;
}

/* Compact form spacing for small screens */
@media (max-width: 576px) {
  .programme-guide { font-size: .88rem; padding: .6rem; }
  .progressbar li::before { width: 26px; height: 26px; line-height: 26px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="fw-bold mb-1">Programme Choice</h3>
      <p class="text-muted mb-0">Pick your preferred programmes and the study format. Provide sponsor details below.</p>
    </div>
    <div class="text-end text-muted small">
      <div>Step 3 of 7</div>
    </div>
  </div>

  <!-- Progress -->
  <ul class="progressbar mb-3" aria-hidden="true">
    <li class="active">Personal</li>
    <li class="active">Guardian</li>
    <li class="active">Programme</li>
    <li>Education</li>
    <li>Exams</li>
    <li>Upload</li>
    <li>Declare</li>
  </ul>

  <div class="row gy-3">
    <!-- Left: programme helper -->
    <div class="col-lg-4">
      <div class="programme-guide mb-3">
        <strong class="d-block mb-1">Programmes (quick guide)</strong>

        <div class="small text-muted mb-2">Certificate Programmes</div>
        <ul class="small mb-2">
          <li>Cyber Security</li>
          <li>Early Childhood Education</li>
          <li>Dispensing Technician II &amp; III</li>
          <li>Diagnostic Medical Sonography</li>
          <li>Medical Laboratory Technology</li>
          <li>Dispensing Assistant</li>
          <li>Health Information Management</li>
          <li>Optical Technician</li>
        </ul>

        <div class="small text-muted mb-2">Diploma Programmes</div>
        <ul class="small mb-0">
          <li>Early Childhood Education</li>
          <li>Midwifery</li>
          <li>Ophthalmic Dispensing</li>
          <li>Medical Laboratory Technology</li>
          <li>HND Dispensing Technology</li>
          <li>Health Information Management</li>
          <li>Diploma in Early Childhood Education</li>
        </ul>
      </div>

      <div class="card shadow-sm d-none d-lg-block">
        <div class="card-body small text-muted">
          <strong>Notes</strong>
          <ul class="mb-0 mt-2">
            <li>1st choice is required.</li>
            <li>2nd &amp; 3rd choices are optional but recommended.</li>
            <li>Choose the study format for each selection.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Right: form -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          Select Programmes & Sponsor Details
        </div>

        <div class="card-body">
          <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <div class="row g-3">
              <!-- 1st choice -->
              <div class="col-md-7">
                <label for="{{ form.first_choice.id }}" class="form-label fw-semibold">1st Choice Programme <span class="text-danger">*</span></label>
                {{ form.first_choice(class="form-select" ~ (" is-invalid" if form.first_choice.errors else ""), id=form.first_choice.id) }}
                {% if form.first_choice.errors %}
                    <div class="invalid-feedback">
                        {{ form.first_choice.errors[0] }}
                    </div>
                {% endif %}
              </div>

              <div class="col-md-5">
                <label for="{{ form.first_stream.id }}" class="form-label fw-semibold">Study Format <span class="text-danger">*</span></label>
                {{ form.first_stream(class="form-select", id=form.first_stream.id) }}
                {% if form.first_stream.errors %}
                  <div class="invalid-feedback d-block">{{ form.first_stream.errors[0] }}</div>
                {% endif %}
              </div>

              <!-- 2nd choice -->
              <div class="col-md-7">
                <label for="{{ form.second_choice.id }}" class="form-label fw-semibold">2nd Choice Programme</label>
                {{ form.second_choice(class="form-select", id=form.second_choice.id) }}
                {% if form.second_choice.errors %}
                  <div class="invalid-feedback d-block">{{ form.second_choice.errors[0] }}</div>
                {% else %}
                  <div class="form-text">Optional — a backup choice.</div>
                {% endif %}
              </div>

              <div class="col-md-5">
                <label for="{{ form.second_stream.id }}" class="form-label fw-semibold">Study Format</label>
                {{ form.second_stream(class="form-select", id=form.second_stream.id) }}
                {% if form.second_stream.errors %}
                  <div class="invalid-feedback d-block">{{ form.second_stream.errors[0] }}</div>
                {% endif %}
              </div>

              <!-- 3rd choice -->
              <div class="col-md-7">
                <label for="{{ form.third_choice.id }}" class="form-label fw-semibold">3rd Choice Programme</label>
                {{ form.third_choice(class="form-select", id=form.third_choice.id) }}
                {% if form.third_choice.errors %}
                  <div class="invalid-feedback d-block">{{ form.third_choice.errors[0] }}</div>
                {% endif %}
              </div>

              <div class="col-md-5">
                <label for="{{ form.third_stream.id }}" class="form-label fw-semibold">Study Format</label>
                {{ form.third_stream(class="form-select", id=form.third_stream.id) }}
                {% if form.third_stream.errors %}
                  <div class="invalid-feedback d-block">{{ form.third_stream.errors[0] }}</div>
                {% endif %}
              </div>

              <!-- Sponsor details -->
              <div class="col-md-6 mt-2">
                <label for="{{ form.sponsor_name.id }}" class="form-label fw-semibold">Name of Sponsor <span class="text-danger">*</span></label>
                {{ form.sponsor_name(class="form-control", id=form.sponsor_name.id, placeholder="Sponsor full name") }}
                {% if form.sponsor_name.errors %}
                  <div class="invalid-feedback d-block">{{ form.sponsor_name.errors[0] }}</div>
                {% endif %}
              </div>

              <div class="col-md-6 mt-2">
                <label for="{{ form.sponsor_relation.id }}" class="form-label fw-semibold">Relationship to Candidate <span class="text-danger">*</span></label>
                {{ form.sponsor_relation(class="form-control", id=form.sponsor_relation.id, placeholder="e.g., Mother, Uncle") }}
                {% if form.sponsor_relation.errors %}
                  <div class="invalid-feedback d-block">{{ form.sponsor_relation.errors[0] }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between align-items-center mt-4">
              <a href="{{ url_for('admissions.guardian') }}" class="btn btn-outline-secondary">Back</a>

              <div>
                <button type="submit" class="btn btn-primary">Save & Continue</button>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div> <!-- /.row -->
</div> <!-- /.container -->

<!-- Prevent duplicate programme selections -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const selects = [
    document.getElementById('{{ form.first_choice.id }}'),
    document.getElementById('{{ form.second_choice.id }}'),
    document.getElementById('{{ form.third_choice.id }}')
  ].filter(Boolean);

  function updateOptions() {
    // Collect selected values
    const chosen = selects.map(s => s.value).filter(v => v);
    selects.forEach(s => {
      Array.from(s.options).forEach(opt => {
        opt.disabled = false; // reset
      });
      // disable selected options in other selects (except the current select's own value)
      selects.forEach(other => {
        if (other === s) return;
        const val = other.value;
        if (val) {
          const option = s.querySelector(`option[value="${CSS.escape(val)}"]`);
          if (option) option.disabled = true;
        }
      });
    });
  }

  selects.forEach(s => s.addEventListener('change', updateOptions));
  updateOptions();
});
</script>
{% endblock %}
