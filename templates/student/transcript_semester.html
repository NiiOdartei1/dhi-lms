{# templates/student/transcript_semester.html #}
{% extends "student/base_student.html" %}

{% block title %}Semester Transcript - {{ transcript.academic_year if transcript else 'Student Portal' }}{% endblock %}

{% block content %}
<div class="container mt-1">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Semester Transcript</h1>
            
            <!-- Transcript Navigation -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body d-flex flex-wrap gap-2">
                    <a href="{{ url_for('student_transcript.current_semester') }}"
                       class="btn {% if request.endpoint == 'student_transcript.current_semester' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="fas fa-file-alt"></i> Current Semester
                    </a>
                    <a href="{{ url_for('student_transcript.full_transcript') }}"
                       class="btn {% if request.endpoint == 'student_transcript.full_transcript' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="fas fa-book-open"></i> Academic History
                    </a>
                </div>
            </div>
            
            {% if transcript %}
                <!-- Transcript Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Student ID:</strong> {{ transcript.student_id }}</p>
                                <p><strong>Name:</strong> {{ transcript.student_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Academic Year:</strong> {{ transcript.academic_year|start_year }}</p>
                                <p><strong>Semester:</strong> {{ transcript.semester }}</p>
                            </div>
                        </div>
                        
                        <!-- Release Status Badge -->
                        {% if transcript.is_released %}
                            <span class="badge bg-success mt-3">Results Released</span>
                        {% else %}
                            <span class="badge bg-warning mt-3">Results Not Yet Released</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- GPA Summary -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">GPA</h5>
                                <p class="display-5">{{ "%.2f"|format(transcript.semester_gpa) }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Weighted GPA</h5>
                                <p class="display-5">{{ "%.2f"|format(transcript.semester_weighted_gpa) }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Credit Hours</h5>
                                <p class="display-5">{{ transcript.total_credit_hours }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Courses Table with Assessment Details -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Course Results with Assessment Breakdown</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th class="text-center">Credits</th>
                                    <th class="text-center">Quiz</th>
                                    <th class="text-center">Assignment</th>
                                    <th class="text-center">Exam</th>
                                    <th class="text-center">Final Score</th>
                                    <th class="text-center">Grade</th>
                                    <th class="text-center">Weights</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in transcript.courses %}
                                <tr>
                                    <td><strong>{{ course.course_code }}</strong></td>
                                    <td>{{ course.course_name }}</td>
                                    <td class="text-center">{{ course.credit_hours }}</td>
                                    <td class="text-center">
                                        {% if course.quiz_max > 0 %}
                                            {{ course.quiz_score }}/{{ course.quiz_max }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if course.assignment_max > 0 %}
                                            {{ course.assignment_score }}/{{ course.assignment_max }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if course.exam_max > 0 %}
                                            {{ course.exam_score }}/{{ course.exam_max }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center fw-bold">{{ "%.2f"|format(course.final_score) }}</td>
                                    <td class="text-center">
                                        <span class="badge {% if course.grade_letter in ['A', 'B'] %}bg-success{% elif course.grade_letter == 'C' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ course.grade_letter or 'N/A' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <small class="text-muted" title="Quiz: {{ course.quiz_weight }}% | Assignment: {{ course.assignment_weight }}% | Exam: {{ course.exam_weight }}%">
                                            Q{{ course.quiz_weight|int }}% A{{ course.assignment_weight|int }}% E{{ course.exam_weight|int }}%
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Assessment Explanation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">How Your Grades Are Calculated</h5>
                    </div>
                    <div class="card-body">
                        <p>Your final grades are calculated by combining three assessment types:</p>
                        <ul>
                            <li><strong>Quizzes:</strong> Regular assessments to check understanding</li>
                            <li><strong>Assignments:</strong> Practical exercises and projects</li>
                            <li><strong>Exams:</strong> Major comprehensive assessments</li>
                        </ul>
                        <p><strong>Weights vary by course.</strong> The "Weights" column shows the percentage each assessment type contributes to your final score for that course. Hover over the weights to see the full breakdown.</p>
                        <p>For example, if a course is Q20% A30% E50%, your final score = (Quiz% × 0.20) + (Assignment% × 0.30) + (Exam% × 0.50).</p>
                    </div>
                </div>
                
                <!-- Download Options -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <a href="{{ url_for('student_transcript.download_semester', academic_year=transcript.academic_year, semester=transcript.semester) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-download"></i> Download This Transcript
                        </a>
                        <a href="{{ url_for('student_transcript.full_transcript') }}" 
                           class="btn btn-secondary">
                            <i class="fas fa-book"></i> View Full Academic History
                        </a>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <p>No transcript data available. Please check back later.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .badge {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
</style>
    
    <!-- Current Semester Info -->
    <div class="alert alert-info">
        <strong>Current Academic Period:</strong> {{ current_year }} - Semester {{ current_semester }}
    </div>
    
    <!-- Semester Overview Table -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Semester Grading Status</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Academic Year</th>
                        <th>Semester</th>
                        <th class="text-center">Courses</th>
                        <th class="text-center">Students</th>
                        <th class="text-center">Grades Entered</th>
                        <th class="text-center">Average GPA</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for status in semester_statuses %}
                    <tr>
                        <td><strong>{{ status.academic_year|start_year }}</strong></td>
                        <td>{{ status.semester }}</td>
                        <td class="text-center">{{ status.total_courses }}</td>
                        <td class="text-center">{{ status.total_students }}</td>
                        <td class="text-center">
                            <span class="badge bg-info">{{ status.total_grades }}</span>
                        </td>
                        <td class="text-center">{{ "%.2f"|format(status.average_gpa) }}</td>
                        <td>
                            {% if status.is_released %}
                                <span class="badge bg-success">Released</span>
                            {% else %}
                                <span class="badge bg-warning">Not Released</span>
                            {% endif %}
                            {% if status.is_locked %}
                                <span class="badge bg-danger">Locked</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                          <a href="{{ url_for('grading.semester_details', academic_year=status.academic_year, semester=status.semester) }}" 
                                   class="btn btn-outline-primary" title="View Details">
                                    <i class="fas fa-eye"></i> Details
                                </a>
                                          {% if not status.is_locked %}
                                          <a href="{{ url_for('grading.finalize_semester', academic_year=status.academic_year, semester=status.semester) }}" 
                                   class="btn btn-outline-success" title="Finalize Grades">
                                    <i class="fas fa-check"></i> Finalize
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Grade Distribution Overview -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Overall Grade Distribution (Current Semester)</h5>
                </div>
                <div class="card-body">
                    {% set current_status = semester_statuses[0] if semester_statuses else {} %}
                    {% if current_status.grade_distribution %}
                        <canvas id="gradeChart"></canvas>
                    {% else %}
                        <p class="text-muted">No grades entered yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Quick Actions</h5>
        </div>
        <div class="card-body">
            <p class="mb-3">
                <strong>Common Tasks:</strong>
            </p>
                <a href="{{ url_for('grading.finalize_semester', academic_year=current_year, semester=current_semester) }}" 
               class="btn btn-primary me-2">
                <i class="fas fa-calculator"></i> Finalize Current Semester
            </a>
                <a href="{{ url_for('grading.semester_details', academic_year=current_year, semester=current_semester) }}" 
               class="btn btn-secondary me-2">
                <i class="fas fa-chart-bar"></i> View Current Semester Stats
            </a>
            <a href="#" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#bulkCalculateModal">
                <i class="fas fa-cogs"></i> Bulk Recalculate
            </a>
        </div>
    </div>
</div>

<!-- Bulk Calculate Modal -->
<div class="modal fade" id="bulkCalculateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Recalculate Grades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                <form method="POST" action="{{ url_for('grading.finalize_semester', academic_year=current_year, semester=current_semester) }}">
                <div class="modal-body">
                    <p>This will recalculate all grades for the selected semester and apply the latest assessment schemes.</p>
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This operation may take a few minutes for large classes.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Proceed with Recalculation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Only draw chart if we have data
    const chartElement = document.getElementById('gradeChart');
    const distribution = {{ current_status.grade_distribution|default({})|tojson }};
    if (chartElement && Object.keys(distribution).length) {
        
        const labels = Object.keys(distribution);
        const data = Object.values(distribution);
        
        const ctx = chartElement.getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Students',
                    data: data,
                    backgroundColor: [
                        '#28a745', // A - green
                        '#17a2b8', // B - cyan
                        '#ffc107', // C - yellow
                        '#fd7e14', // D - orange
                        '#dc3545', // F - red
                    ],
                    borderColor: '#ddd',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Students'
                        }
                    }
                }
            }
        });
    }
});
</script>

<style>
    .card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.65rem;
    }
    
    .btn-group-sm {
        gap: 0.25rem;
    }
</style>
{% endblock %}